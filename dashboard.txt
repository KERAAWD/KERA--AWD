<<dd_version: 1>>
<<dd_do:nocommands nooutput>>
clear all 
set more off 
capture log off
set linesize 255
log using "C:\Users\LVarkey\OneDrive - CGIAR\Desktop\Kerala_IRRI Work\KERA\Data file_LCAS\Stata data files\KERA_DASHBOARD\Dasboard_log.smcl",replace
version 15.1
display "{hilite}>>>>Universal Codes: .n=no response for missing/no response data(Earlier 9998); 9999/Dont' know for don't know {txt}
* Set the working directory
cd "C:\Users\LVarkey\OneDrive - CGIAR\Desktop\Kerala_IRRI Work\KERA\Data file_LCAS\Stata data files\KERA_DASHBOARD"

* Open data file created by Kera_dashboard.do

use "LCAS.dta"

*.......................................................................
*                        IDENTIFIER INFORMATION
*....................................................................... 

sort state district_mod block_mod PSSID_mod panchayat_mod household_id
<</dd_do>>
<<dd_include: header.txt >>
<a id="top"></a>
<h2 style="
  background: 
    linear-gradient(to right, rgba(179, 157, 219, 0.85), rgba(209, 196, 233, 0.85)), 
    url('header.png');
  background-size: cover;
  background-position: center;
  color: white;
  padding: 10px 25px;
  border-radius:0;
  text-align: center;
  font-family: 'Segoe UI', sans-serif;
  text-shadow: 1px 1px 3px #6a1b9a;
  display: flex;
  justify-content: center;
  align-items: center;
  height: 150px;
  position: relative;
  margin: 0; 
">

   <!-- Dashboard Logo -->
   <img src="KERA_dashboard.png" alt="Dashboard" style="
      height: 200%;
      object-fit: contain;
   ">

   <!-- Back Button -->
   <a href="index.html" class="back-home-header">
      ‚¨ÖBack to Home (KERA-AWD)
   </a>

</h2>

<!-- HEADER WITH TABS + SEARCH + DOWNLOAD--> 
<html>
<head>
<meta charset="utf-8">
<title>Dashboard √É¬¢√¢‚Äö¬¨√¢‚Ç¨¬ù tabs + subtabs + search + PDF</title>

<style>
  :root {
  --main-green: #4CAF50;
  --main-green-dark: #2E7D32;
  --sub-bg: #e8f7f0;
  --sub-pill: #00796b;
}
object-fit: cover;
width: 100%;
height: 100%;

body {
  font-family: Arial, sans-serif;
  margin: 0;
  background: #fafafa;
}

body {
  margin: 0;
  padding: 0
}

h1, h2, h3 {
  margin: 0;
}

h1, h2, h3 {
  margin: 0;
}

/* Blinking download button */
@keyframes blinkFlash {
  0%, 100% { opacity: 1; color: #fff; }
  50% { opacity: 0.5; color: yellow; }
}
#downloadBtn {
  position: fixed;
  right: 16px;
  top: 12px;
  z-index: 9999;
  background: var(--main-green);
  border: none;
  padding: 8px 12px;
  border-radius: 6px;
  cursor: pointer;
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
  font-weight: 600;
  font-family: 'Courier New', Courier, monospace;
  animation: blinkFlash 1.5s infinite;
  color: white;
}
#downloadBtn:hover {
  background: var(--main-green-dark);
}

/* Top bar with tabs left, search right */
.tab-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: linear-gradient(to right, #111, #333);
  padding: 8px 12px;
  position: sticky;
  margin: 0;
  margin-top: 0;
  top: 0;
  z-index: 500;
  color: white;
}
.tab-links {
  display: flex;
  gap: 6px;
}
.tab-link {
  background: transparent;
  border: none;
  color: white;
  cursor: pointer;
  padding: 8px 12px;
  font-weight: 600;
  border-radius: 6px;
}
.tab-link:hover { background: rgba(255,255,255,0.08); }
.tab-link.active { background: rgba(0,0,0,0.12); }

.search-box {
  display: flex;
  align-items: center;
}
.search-box input {
  padding: 6px 8px;
  border-radius: 6px;
  border: none;
  outline: none;
  width: 220px;
}
.search-box button {
  margin-left: 6px;
  padding: 6px 10px;
  border-radius: 6px;
  border: none;
  cursor: pointer;
  background: var(--main-green-dark);
  color: white;
  font-weight: 600;
}

/* Container + tab contents */
.container {
  padding: 16px;
  max-width: 1200px;
  margin: 70px auto 80px;
}
.tab-content {
  display: none;
  background: white;
  padding: 16px;
  border: 1px solid #e0e0e0;
  border-radius: 6px;
}
.tab-content.active { display: block; }

/* Subtabs for Production */
.production-subtab-area {
  display: none;
  background: var(--sub-bg);
  padding: 8px 12px;
  border-bottom: 1px solid rgba(0,0,0,0.06);
}
.sub-tab-link {
  background: transparent;
  border: 1px solid var(--sub-pill);
  color: var(--sub-pill);
  padding: 6px 10px;
  border-radius: 12px;
  cursor: pointer;
  margin-right: 8px;
}
.sub-tab-link.active {
  background: var(--sub-pill);
  color: white;
}

/* Highlight search */
mark.highlight {
  background: yellow;
  color: black;
}

/* Responsive */
@media (max-width: 760px) {
  .search-box input { width: 120px; }
  .tab-links { overflow-x: auto; }
}

/* Show all tabs in print mode */
.print-mode .tab-content {
  display: block !important;
}

//Hiding image tab during printing
.print-mode #image {
  display: none !important;
}


/* Show all subtabs in print mode */
.print-visible {
  display: block !important;
}

.green-note {
  background-color: #e6f4ea; /* light green */
  border-left: 6px solid #4CAF50; /* darker green stripe */
  padding: 10px 14px;
  margin: 12px 0;
  border-radius: 6px;
  font-size: 14px;
  font-style: italic;
  color: #2E7D32; /* dark green text */
}
.tab-content {
    padding-bottom: 70px; /* height of footer + some space */
}

mark.highlight {
  background: yellow;
}

mark.active-match {
  background: orange;
}

@keyframes blinkHeader {
  0%   { background-color: #2E7D32; }
  25%  { background-color: #ff9800; }
  50%  { background-color: #e91e63; }
  75%  { background-color: #2196f3; }
  100% { background-color: #2E7D32; }
}

.back-home-header {
  position: absolute;
  top: 65px;        /* LOWER than download button */
  right: 25px;
  padding: 6px 14px;
  border-radius: 6px;
  text-decoration: none;
  color: white;
  font-weight: 700;
  font-size: 14px;
  animation: blinkHeader 1.5s infinite;
  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
}

.gallery-item {
  display: inline-block;
  margin: 10px;
  text-align: center;
}

</style>
</head>

<body>
<div id="dashboardContent">
   
<!-- Fixed download button -->
<button id="downloadBtn" title="Download all tabs">‚¨áÔ∏èDownload Full Report</button>

<!-- Tab bar -->
<div class="tab-bar">
  <div class="tab-links">
    <button class="tab-link active" data-target="home" onclick="openTab(event,'home')"Home</button>
    <button class="tab-link" data-target="initialoverview" onclick="openTab(event,'initialoverview')">Overview</button>
    <button class="tab-link" data-target="agrlland" onclick="openTab(event,'agrlland')">Agricultural Land</button>
    <button class="tab-link" data-target="production" onclick="openTab(event,'production')">Production Details</button>
    <button class="tab-link" data-target="residue" onclick="openTab(event,'residue')">Residue management</button>
    <button class="tab-link" data-target="GHG" onclick="openTab(event,'GHG')">GHG Emissions</button>
    <button class="tab-link" data-target="attitude" onclick="openTab(event,'attitude')">Knowledge and willingness towards LEPs</button>
    <button class="tab-link" data-target="image" onclick="openTab(event,'image')">üì∑Image gallery </button>
    <button class="tab-link" data-target="download" onclick="openTab(event,'download')">‚¨áÔ∏èDownloads </button>
  </div>

  <div class="search-box">
    <input id="searchInput" placeholder="Search...">
    <button id="searchBtn">üîç</button>
    <button id="clearSearch">‚úñ</button>
  </div>
</div>

<div class="container" id="pdfRoot">
<div id="home" class="tab-content active">
<h4 style="color:darkblue;margin-top:5px;"><strong>Background</strong></h4>
<div style="text-align:center;">
    <img src="Kerala.png" alt="Kerala" width="800">
</div

This dashboard/report provides automated insights into the drivers and outcomes of paddy production systems at the landscape level in Kerala√É¬¢√¢‚Äö¬¨√¢‚Äû¬¢s two major paddy-growing regions- the Kole lands of Thrissur and the paddy belts of Palakkad. It summarises key findings from the Landscape Assessment Survey (LCAS) conducted in these two districts as part of Component 1.2, Alternate Wetting and Drying (AWD)- Catalysing Transitions to Low-Emission Rice-Based Systems in Kerala, under the KERA initiative.

Building a comprehensive data stack for digital landscape analytics and systems assessment is essential for identifying greenhouse gas (GHG) emission hotspots. This foundation will support the co-development and strategic targeting of low-emission packages (LEPs), minimizing unintended consequences while capturing potential positive externalities.
</div>

<!-- SUBSECTION  1:Overview -->
<div id="initialoverview" class="tab-content">
<h4 style="color:darkblue;margin-top:5px;"><strong> 
Initial Overview</strong></h4>

<!-- To create space between the next paragraph and the following graph -->
<div style="margin-bottom: 40px;">
The dataset contains data from the following districts of Kerala: <strong>Palakkad</strong>, and <strong>Thrissur</strong> from the years 2023 and 2024 for the 3 major cropping seasons of rice,namely Virippu,Mundakan and Puncha. The dataset contains 1,239 samples, and the following distribution of samples across the sample districts:
</div>


<<dd_do:nocommands nooutput>>
use mydb, clear
spmap fillcolor using "mycoord.dta", id(id) point(data("GPS ids of HH respondents_longform_modified_valid GPS points.dta") x(longitude_h) y(latitude_h) fcolor(orange) size(vsmall) shape(diamond) ocolor(black))fcolor(green%40) ocolor(black) title("{bf:Plots of LCAS survey respondents}") legend(off)
graph export "spmap_output.png", replace width(2000)
<</dd_do>>

<<dd_do:nocommands>>
use "LCAS.dta",clear
preserve
egen panch_tag    = tag(district_mod panchayat_mod)
egen block_tag    = tag(district_mod block_mod)
egen pss_tag    = tag(district_mod PSSID_mod)
egen farmer_tag = tag(district_mod household_id)
collapse (sum)  panch_tag block_tag pss_tag farmer_tag, by(district_mod)
rename (farmer_tag pss_tag panch_tag block_tag) (n_farmers n_padasekharams n_panchayats n_blocks)
egen total_farmers = total(n_farmers)
egen total_pss     = total(n_padasekharams)
egen total_blocks     = total(n_blocks)
egen total_panchayats    = total(n_panchayats)
gen pct_farmers = 100 * n_farmers / total_farmers
<</dd_do>>

<<dd_do:nocommands nooutput>>
tempfile summary_data
save `summary_data'
restore
use `summary_data', clear
levelsof district_mod, local(districts)
<</dd_do>>

<!-- Side-by-side layout container -->
<div style="display: flex; justify-content: center; align-items: flex-start; gap: 40px;">

  <!-- Image container -->
  <div>
    <img src="LCAS_survey_map_mod.png" alt="PLOT GPS" width="600">
  </div>

 <!-- Tables stacked vertically next to image -->
 <div style="display: flex; flex-direction: column; gap: 20px;">
 
  <!-- First table -->
  <div>
    <table border="1" style="border-collapse: collapse; width: 75%; text-align: center;margin-top:30px">
      <thead style="background-color: #f2f2f2;">
        <tr>
          <th>District</th>
          <th>Number of blocks</th>
          <th>Number of panchayats</th>
        </tr>
      </thead>

       <<dd_do:nocommands >>
        foreach d in `districts' {
        qui su n_blocks if district_mod == `d', meanonly
        local pb  = string(r(mean), "%9.2f")
        qui su n_panchayats  if district_mod ==`d', meanonly
        local ppc = string(r(mean), "%9.2f")
        local name : label (district_mod) `d'
        di "<tr><td>`name'</td><td>`pb'</td><td>`ppc'</td></tr>"
       }
     <</dd_do>>  
   </table>
  </div>
  <!-- Second table -->
  <div>
    <table border="1" style="border-collapse: collapse; width: 75%; text-align: center;">
      <thead style="background-color: #f2f2f2;">
        <tr>
          <th>District</th>
          <th>Number of padasekharams</th>
          <th>% of farmer respondents</th>
        </tr>
      </thead>

       <<dd_do:nocommands >>
        foreach d in `districts' {
        qui su n_padasekharams if district_mod == `d', meanonly
        local pp  = string(r(mean), "%9.2f")
        qui su pct_farmers   if district_mod == `d', meanonly
        local pf  = string(r(mean), "%9.2f")
        local name : label (district_mod) `d'
        di "<tr><td>`name'</td><td>`pp'</td><td>`pf'</td></tr>"
       }
     <</dd_do>>  
   </table>
  </div>
 </div>
</div>

<!-- SUBSECTION  2:Demography -->
<h4 id="demography" style="color:darkblue;margin-top:5px"><strong>Demography</strong></h4>

       <<dd_do:nocommands nooutput >>
       use "LCAS.dta",clear
       sum resp_age,detail
       local Age_mean = string(r(mean), "%9.2f")
       local Age_sd = string(r(sd), "%9.2f")
       sum resp_farmexp,detail
       local FE_mean = string(r(mean), "%9.2f")
       local FE_sd = string(r(sd), "%9.2f")
       spikeplot resp_age if district_mod == 1, fraction color(navy%40) lpattern(solid) title("{bf:Palakkad}") lwidth (vthick) scheme(white_brbg) ytitle (Fraction) xtitle(Age(years))plotregion(ilcolor(black) ilpattern(vshortdash))
     graph save Age_PKD.gph, replace
     spikeplot resp_age if district_mod == 2, fraction color(red%30) lpattern(solid) title("{bf:Thrissur}") lwidth (vthick) scheme(white_brbg) ytitle(Fraction) xtitle(Age (years)) plotregion(ilcolor(black) ilpattern(vshortdash)) 
     graph save Age_TSR.gph, replace
     graph combine Age_PKD.gph Age_TSR.gph, cols(2)
     graph export "Age.png", replace width(1200)
 spikeplot resp_farmexp if district_mod == 1, fraction color(navy%40) lpattern(solid) title("{bf:Palakkad}") lwidth (vthick) scheme(white_brbg) ytitle (Fraction) xtitle(Farming experience(years))plotregion(ilcolor(black) ilpattern(vshortdash))
     graph save FE_PKD.gph, replace
     spikeplot resp_farmexp if district_mod == 2, fraction color(red%30) lpattern(solid) title("{bf:Thrissur}") lwidth (vthick) scheme(white_brbg) ytitle(Fraction) xtitle(Farming experience(years)) plotregion(ilcolor(black) ilpattern(vshortdash)) 
     graph save FE_TSR.gph, replace
     graph combine FE_PKD.gph FE_TSR.gph, cols(2)
     graph export "FE.png", replace width(1200)
      <</dd_do>>
<h4 style="text-align: left;"><strong>Age & Farming Experience</strong></h4>

The average age of the respondent is  <<dd_display:`Age_mean'>> years, with a standard deviation of <<dd_display:`Age_sd'>> years.The average farming experience of the respondent is  <<dd_display:`FE_mean'>> years, with a standard deviation of <<dd_display:`FE_sd'>> years.The distribution is as follows:

<!-- Side-by-side table layout container -->
<!-- First table -->
<div style="display: flex; justify-content: center; align-items: flex-start; gap: 40px;"> 
 <div>
    <table border="1" style="border-collapse: collapse; width: 100%; text-align: center;">
      <thead style="background-color: #f2f2f2;">
        <tr>
          <th>District</th>
          <th>Age of the respondent(years)</th>
        </tr>
      </thead>
        <<dd_do:nocommands >>
        foreach d in `districts' {
          qui su resp_age if district_mod == `d', meanonly
          local Age_P = r(mean)
          local name : label (district_mod) `d'
          di "<tr><td>`name'</td><td>" %6.2f `Age_P' "</td></tr>"
        }
     <</dd_do>>  
   </table>
 </div>
 <!-- Second table -->
  <div>
    <table border="1" style="border-collapse: collapse; width: 100%; text-align: center;">
      <thead style="background-color: #f2f2f2;">
        <tr>
          <th>District</th>
          <th>Farming experience respondent(years)</th>
        </tr>
      </thead>
       <<dd_do:nocommands >>
        foreach d in `districts' {
        qui su resp_farmexp if district_mod == `d', meanonly
        local FE_P = r(mean)
        local name : label (district_mod) `d'
        di "<tr><td>`name'</td><td>" %6.2f `FE_P' "</td></tr>"
       }
     <</dd_do>>  
   </table>
  </div>
</div>

<!-- Side-by-side image layout container -->
<div style="display: flex; justify-content: center; align-items: flex-start; gap: 40px;">
  <!-- Image container -->
  <div>
   <img src="Age.png" alt="Distribution of respondent age by district" width="500">
  </div>
  <div>
   <img src="FE.png" alt="Distribution of farming experience by district" width="500">
  </div>
</div>

The composition of the sample based on caste,gender,educational qualifications and marital status is as follows:

<!--Caste-->
<<dd_do:nocommands nooutput>>
preserve
contract district_mod caste 
bysort district_mod (caste): gen total = sum(_freq)
bysort district_mod (caste): replace total = total[_N]
bysort district_mod (caste): gen percent = 100 * _freq / total
replace percent=round(percent,0.01)
drop _freq total
reshape wide percent , i(district_mod) j(caste)
capture confirm variable percent9998
if _rc == 0 {
    rename percent9998 percent6
}
forval i = 1/6 {
    capture confirm variable percent`i'
    if _rc == 0 {
        replace percent`i' = 0 if missing(percent`i')
    }
}
renvars percent1 percent2 percent3 percent4 percent5 /General OBC SC ST Others
tempfile caste_data
save `caste_data'
restore
use `caste_data', clear
tempfile htmlout
file open outfile using `htmlout', write replace
file write outfile "<h4 style='text-align: left;'>Caste</h4>" _n
file write outfile "<tr style='background-color:#f2f2f2;'><th>District</th><th>General (%)</th><th>OBC (%)</th><th>SC (%)</th><th>ST (%)</th></tr>" _n
levelsof district_mod, local(districts)
<</dd_do>>

<!-- First table(Caste)-->
<div>
  <table border="1" style="border-collapse: collapse; width: 75%; font-size:100%; text-align: center;">
       <<dd_do:nocommands >>
        foreach d in `districts' {
        qui su General if district_mod == `d', meanonly
        local G  = string(r(mean), "%9.2f")
        qui su OBC  if district_mod ==`d', meanonly
        local OBC = string(r(mean), "%9.2f")
        qui su SC if district_mod == `d', meanonly
        local SC  = string(r(mean), "%9.2f")
        qui su ST  if district_mod ==`d', meanonly
        local ST = string(r(mean), "%9.2f")
        local name : label (district_mod) `d'
        file write outfile "<tr><td> `name' </td><td>`G'</td><td>`OBC'</td><td> `SC' </td><td>`ST' </td></tr>" _n
 }
       file write outfile "</table>" _n
       file close outfile
       type `htmlout'
     <</dd_do>> 
   </table>
 </div>

<!-- Gender-->
<<dd_do:nocommands nooutput>>
use "LCAS.dta",clear
preserve
contract district_mod resp_gender
bysort district_mod (resp_gender): gen total = sum(_freq)
bysort district_mod (resp_gender): replace total = total[_N]
bysort district_mod (resp_gender): gen percent = 100 * _freq / total
replace percent=round(percent,0.01)
drop _freq total
reshape wide percent , i(district_mod) j(resp_gender)
capture confirm variable percent9998
if _rc == 0 {
    rename percent9998 percent3
}
forval i = 1/3 {
    capture confirm variable percent`i'
    if _rc == 0 {
        replace percent`i' = 0 if missing(percent`i')
    }
}
renvars percent1 percent2 /Male Female
tempfile gender_data
save `gender_data'
restore
use `gender_data', clear
tempfile htmlout
file open outfile using `htmlout', write replace
file write outfile "<h4 style='text-align: left;'>Gender</h4>" _n
file write outfile "<tr style='background-color:#f2f2f2;'><th>District</th><th>Male (%)</th><th>Female(%)</th></tr>" _n
levelsof district_mod, local(districts)
<</dd_do>>
 
<!-- Second table (Gender)-->
 <div>
  <table border="1" style="border-collapse: collapse; width: 40%; font-size:100%; text-align: center;">
       <<dd_do:nocommands >>
        foreach d in `districts' {
        qui su Male if district_mod == `d', meanonly
        local M  = string(r(mean), "%9.2f")
        qui su Female  if district_mod ==`d', meanonly
        local F = string(r(mean), "%9.2f")
        local name : label (district_mod) `d'
        file write outfile "<tr><td> `name' </td><td>`M'</td><td>`F'</td></tr>" _n
 }
       file write outfile "</table>" _n
       file close outfile
       type `htmlout'
     <</dd_do>> 
  </table>
 </div>

<!--Education-->

<<dd_do:nocommands nooutput>>
capture file close outfile
use "LCAS.dta",clear
preserve
contract district_mod resp_educ 
bysort district_mod (resp_educ): gen total = sum(_freq)
bysort district_mod (resp_educ): replace total = total[_N]
bysort district_mod (resp_educ): gen percent = 100 * _freq / total
replace percent=round(percent,0.01)
drop _freq total
reshape wide percent , i(district_mod) j(resp_educ)
capture confirm variable percent9998
if _rc == 0 {
    rename percent9998 percent12
}
forval i = 1/12 {
    capture confirm variable percent`i'
    if _rc == 0 {
        replace percent`i' = 0 if missing(percent`i')
    }
}
tempfile ed_data
save `ed_data'
use `ed_data', clear
tempfile htmlout
file open outfile using `htmlout', write replace
file write outfile "<h4 style='text-align: left;'>Education</h4>" _n
levelsof district_mod, local(districts)
<</dd_do>> 
<!-- Third table(Education)-->
  <div>
    <table border="1" style="border-collapse: collapse; width: 85%; font-size: 100%; text-align: center;">
      <thead style="background-color: #f2f2f2;">
<tr style="font-size: 12px;" ><th>District</th><th>Illiterate (%)</th><th>No formal education (%)</th><th>Primary School (class 1 - 5) (%)</th><th>Middle School (class 6 - 8)(%)</th><th>Secondary School (class 9 - 10) (%) </th><th> Higher Secondary/Vocational (class 11 - 12) (%)</th><th>Diploma/Certificate (after class 10)(%)</th><th>Diploma/Certificate (after class 12)(%)</th><th> Graduate (%)</th><th>Postgraduate(%)</th></tr>
      </thead>
       <<dd_do:nocommands nooutput >>
        foreach d in `districts' {
        qui su percent1 if district_mod == `d', meanonly
        local p1  = string(r(mean), "%9.2f")
        qui su percent2  if district_mod ==`d', meanonly
        local p2 = string(r(mean), "%9.2f")
        qui su percent3 if district_mod == `d', meanonly
        local p3  = string(r(mean), "%9.2f")
        qui su percent4  if district_mod ==`d', meanonly
        local p4 = string(r(mean), "%9.2f")
        qui su percent5 if district_mod == `d', meanonly
        local p5  = string(r(mean), "%9.2f")
        qui su percent6  if district_mod ==`d', meanonly
        local p6 = string(r(mean), "%9.2f")
        qui su percent7 if district_mod == `d', meanonly
        local p7  = string(r(mean), "%9.2f")
        qui su percent8  if district_mod ==`d', meanonly
        local p8 = string(r(mean), "%9.2f")
        qui su percent9 if district_mod == `d', meanonly
        local p9  = string(r(mean), "%9.2f")
        qui su percent10  if district_mod ==`d', meanonly
        local p10 = string(r(mean), "%9.2f")
        local name : label (district_mod) `d'
        file write outfile "<tr>" _n
        file write outfile "<td>`name'</td>" 
        file write outfile "<td>`p1'</td>"
        file write outfile "<td>`p2'</td>"
        file write outfile "<td style='width: 90px;padding: 10px;'>`p3'</td>"
        file write outfile "<td style='width: 90px;padding: 10px;'>`p4'</td>"
        file write outfile "<td style='width: 90px;'>`p5'</td>"
        file write outfile "<td>`p6'</td>"
        file write outfile "<td>`p7'</td>"
        file write outfile "<td>`p8'</td>"
        file write outfile "<td>`p9'</td>"
        file write outfile "<td>`p10'</td>"
        file write outfile "</tr>" _n
     }
       file close outfile
      <</dd_do>> 
      <<dd_do:nocommands>>
       type `htmlout' 
       restore
       <</dd_do>>
  </table>
 </div> 
     
 <!-- Marital status-->

<<dd_do:nocommands nooutput>>
use "LCAS.dta",clear
preserve
contract district_mod resp_marital if resp_marital!=9998
bysort district_mod (resp_marital): gen total = sum(_freq)
bysort district_mod (resp_marital): replace total = total[_N]
bysort district_mod (resp_marital): gen percent = 100 * _freq / total
replace percent=round(percent,0.01)
drop _freq total
reshape wide percent , i(district_mod) j(resp_marital)
capture confirm variable percent9998
if _rc == 0 {
    rename percent9998 percent6
}
forval i = 1/6 {
    capture confirm variable percent`i'
    if _rc == 0 {
        replace percent`i' = 0 if missing(percent`i')
    }
}
renvars percent1 percent2 percent3 percent4 percent5/Single Married Divorced Separated Widowed
tempfile mar_data
save `mar_data'
restore
use `mar_data', clear
tempfile htmlout
file open outfile using `htmlout', write replace
file write outfile "<h4 style='text-align: left;'>Marital status</h4>" _n
file write outfile "<tr style='background-color:#f2f2f2;'><th>District</th><th>Single(%)</th><th>Married(%)</th><th>Divorced(%)</th><th>Separated(%)</th><th>Widowed(%)</th></tr>" _n
levelsof district_mod, local(districts)
<</dd_do>>

<!-- Second table (Marital status)-->
 <div>
  <table border="1" style="border-collapse: collapse; width: 75%; font-size:100%; text-align: center;">
   <thead style="background-color: #f2f2f2;">
   </thead>
       <<dd_do:nocommands >>
        foreach d in `districts' {
        qui su Single if district_mod == `d', meanonly
        local Si = string(r(mean), "%9.2f")
        qui su Married  if district_mod ==`d', meanonly
        local M = string(r(mean), "%9.2f")
        qui su Divorced if district_mod == `d', meanonly
        local D  = string(r(mean), "%9.2f")
        qui su Separated  if district_mod ==`d', meanonly
        local S = string(r(mean), "%9.2f")
        qui su Widowed  if district_mod ==`d', meanonly
        local W = string(r(mean), "%9.2f")
        local name : label (district_mod) `d'
        file write outfile "<tr><td> `name' </td><td>`Si'</td><td>`M'</td><td>`D'</td><td>`S'</td><td>`W'</td></tr>" _n
 }
       file write outfile "</table>" _n
       file close outfile
       type `htmlout'
     <</dd_do>> 
  </table>
 </div>
<!-- SUBSECTION  3:Household Economic Profile -->
<h4 id="householdeconomicprofile" style="color:darkblue;margin-top:5px;"><strong>Household Economic Profile</strong></h4> 
     
<!--Annual HH Income-->
<<dd_do:nocommands nooutput>>
use "LCAS.dta",clear
preserve
    contract district_mod annual_hhincome 
    bysort district_mod (annual_hhincome): gen total = sum(_freq)
    bysort district_mod (annual_hhincome): replace total = total[_N]
    bysort district_mod (annual_hhincome): gen percent = 100 * _freq / total
    replace percent=round(percent,0.01)
    drop _freq total
    reshape wide percent , i(district_mod) j(annual_hhincome)
capture confirm variable percent9998
if _rc == 0 {
    rename percent9998 percent9
}
forval i = 1/9 {
    capture confirm variable percent`i'
    if _rc == 0 {
        replace percent`i' = 0 if missing(percent`i')
    }
}
tempfile Income_data
save `Income_data'
restore
use `Income_data', clear
tempfile htmlout
file open outfile using `htmlout', write replace
levelsof district_mod, local(districts)
<</dd_do>>
<h4 style='text-align: left;'>Annual household income</h4>
The composition of annual household income amongst the respondents is as follows:

<!-- First table(Annual HH Income)-->
<div>
  <table border="1" style="border-collapse: collapse; width: 75%; font-size:100%; text-align: center;">
  <tr style='background-color:#f2f2f2;font-size:12px;'><th>District</th><th>&lt; √É¬¢√¢‚Ç¨≈°√Ç¬π 50,000 (%)</th><th>√É¬¢√¢‚Ç¨≈°√Ç¬π 50,000-√É¬¢√¢‚Ç¨≈°√Ç¬π 1,00,000 (%)</th><th>√É¬¢√¢‚Ç¨≈°√Ç¬π 1,00,001- √É¬¢√¢‚Ç¨≈°√Ç¬π 2,50,000 (%)</th><th>√É¬¢√¢‚Ç¨≈°√Ç¬π 2,50,001- √É¬¢√¢‚Ç¨≈°√Ç¬π 5,00,000 (%)</th><th>√É¬¢√¢‚Ç¨≈°√Ç¬π 5,00,001- √É¬¢√¢‚Ç¨≈°√Ç¬π 10,00,000 (%)</th><th>√É¬¢√¢‚Ç¨≈°√Ç¬π 10,00,001- √É¬¢√¢‚Ç¨≈°√Ç¬π 15,00,000 (%)</th><th>√É¬¢√¢‚Ç¨≈°√Ç¬π 15,00,001- √É¬¢√¢‚Ç¨≈°√Ç¬π 20,00,000 (%)</th><th>&gt; √É¬¢√¢‚Ç¨≈°√Ç¬π 20,00,000 (%)</th></tr>
       <<dd_do:nocommands >>
        foreach d in `districts' {
        qui su percent1 if district_mod == `d', meanonly
        local p1  = string(r(mean), "%9.2f")
        qui su percent2  if district_mod ==`d', meanonly
        local p2 = string(r(mean), "%9.2f")
        qui su percent3 if district_mod == `d', meanonly
        local p3  = string(r(mean), "%9.2f")
        qui su percent4 if district_mod ==`d', meanonly
        local p4 = string(r(mean), "%9.2f")
        qui su percent5 if district_mod == `d', meanonly
        local p5 = string(r(mean), "%9.2f")
        qui su percent6  if district_mod ==`d', meanonly
        local p6 = string(r(mean), "%9.2f")
        qui su percent7 if district_mod == `d', meanonly
        local p7  = string(r(mean), "%9.2f")
        qui su percent8  if district_mod ==`d', meanonly
        local p8 = string(r(mean), "%9.2f")
        local name : label (district_mod) `d'
        file write outfile "<tr><td> `name' </td><td>`p1'</td><td>`p2'</td><td> `p3' </td><td>`p4' </td><td>`p5'</td><td>`p6'</td><td> `p7' </td><td>`p8' </td></tr>" _n
 }
       file write outfile "</table>" _n
       file close outfile
       type `htmlout'
     <</dd_do>> 
   </table>
 </div>
 
<!--Share of agriculture in HH income-->

<h4 style='text-align: left;'<strong>Share of agriculture in household income</strong></h4
  <<dd_do:nocommands nooutput>>
       use "LCAS.dta",clear 
      spikeplot share_totalhhincome_agri if district_mod == 1, fraction color(red%50) lpattern(solid) title("{bf:Palakkad}") lwidth (vthick) xlabel(0 (20) 100) scheme(white_brbg) ytitle(Fraction) xtitle(Share of agriculture in household income) xmtick(10 (10) 90)plotregion(ilcolor(black) ilpattern(vshortdash))
      graph save spikeplotPalakkad_incomeshareagri.gph, replace
      spikeplot share_totalhhincome_agri if district_mod == 2, fraction color(green%30) lpattern(solid) title("{bf:Thrissur}") lwidth (vthick) xlabel(0 (20) 100) scheme(white_brbg) ytitle(Fraction) xtitle(Share of agriculture in household income) xmtick(10 (10) 90) plotregion(ilcolor(black) ilpattern(vshortdash))
      graph save spikeplotThrissur_incomeshareagri.gph, replace
      graph combine  spikeplotPalakkad_incomeshareagri.gph spikeplotThrissur_incomeshareagri.gph, cols(2)    
      graph export "spikeplot_agriincoemshare.png", replace width(1200)
      <</dd_do>>

The distribution of the proportional share of agriculture in household income is as follows:
 
<!-- Image container -->
  <div style="text-align:center;">
   <img src="spikeplot_agriincoemshare.png" alt="Distribution of respondent age by district" width="500">
  </div>

<!--Loan availed-->
<<dd_do:nocommands nooutput >>
use "LCAS.dta", clear
* Temporary file to store the combined result 
tempfile Season_data
   preserve
        contract district_mod loan_availed
        bysort district_mod (loan_availed): gen total = sum(_freq)
        bysort district_mod (loan_availed): replace total = total[_N]
        bysort district_mod (loan_availed): gen percent = 100 * _freq / total
        replace percent = round(percent,0.01)
        drop _freq total
        reshape wide percent, i(district_mod) j(loan_availed)
        keep district_mod percent1
        tempfile tmp
        save `tmp'
        save `Season_data', replace
        use `Season_data', clear

tempfile htmlout
file open outfile using `htmlout', write replace
levelsof district_mod, local(districts)
<</dd_do>>

<h4 style='text-align: left;'>Indebtedness</h4>

The proportion of respondents who have current outstanding loans is as follows:

<div>
<table border='1' style='border-collapse: collapse; width: 25%; font-size:100%; text-align: center;'>
<tr style='background-color:#f2f2f2;'><th>District</th><th>Has outstanding loan (%)</th></tr>

 <<dd_do:nocommands>>
foreach d of local districts {
    quietly su percent1 if district_mod == `d', meanonly
    local p1 = string(r(mean), "%9.2f")
    local name : label (district_mod) `d'
    file write outfile "<tr><td>`name'</td><td>`p1'</td></tr>" _n
}
file write outfile "</table>" _n
file close outfile
type `htmlout'
<</dd_do>>
 </table>
</div>
</div>
<!-- SUBSECTION  4:Agricultural Land -->
<div id="agrlland" class="tab-content"> 
<h4 id="agrlland" style="color:darkblue;margin-top:5px;"><strong>Details of agricultural land</strong></h4>

       <<dd_do:nocommands nooutput >>
       use "LCAS.dta",clear
       sum Owned_landarea_acre,detail
       local Owned_mean = string(r(mean), "%9.2f")
       local Owned_sd = string(r(sd), "%9.2f")
       sum leasedin_landarea_acre,detail
       local Leased_mean = string(r(mean), "%9.2f")
       local Leased_sd = string(r(sd), "%9.2f") 
       <</dd_do>>
<h4 style='text-align: left;'<strong>Possession of owned/leased-in agricultural land</strong></h4

The average size of the owned agricultural land is <<dd_display:`Owned_mean'>> acres, with a standard deviation of <<dd_display:`Owned_sd'>> acres.
The average size of the leased-in agricultural land is <<dd_display:`Leased_mean'>> acres, with a standard deviation of <<dd_display:`Leased_sd'>> acres.The distribution is as follows:

 <!-- Table container -->
  <div>
    <table border="1" style="border-collapse: collapse; width: 100%; text-align: center;">
      <thead style="background-color: #f2f2f2;">
        <tr>
          <th>District</th>
          <th>Owned ag.land(acres)</th>
          <th>Leased-in ag.land (acres)</th>
        </tr>
      </thead>
        <<dd_do:nocommands >>
        foreach d in `districts' {
          qui su Owned_landarea_acre if district_mod == `d', meanonly
          local pt = r(mean)
          qui su leasedin_landarea_acre if district_mod == `d', meanonly
          local pl = r(mean)
          local name : label (district_mod) `d'
          di "<tr><td>`name'</td><td>" %6.2f `pt' "</td><td>" %6.2f `pl' "</td></tr>"
        }
     <</dd_do>>  
   </table>
 </div>
<!-- Graph of distribution (Owned & leasedin) -->

<<dd_do:nocommands nooutput >>
local colors "green%40 maroon%30"
local titles "Palakkad Thrissur"
local i = 1        
foreach d of numlist 1/2 {
    local color : word `i' of `colors'
    local title : word `i' of `titles'
    spikeplot Owned_landarea_acre if district_mod == `d', fraction color(`color') lpattern(solid) title(`"{bf:`title'}"' ) lwidth(vthick) scheme(white_brbg) ytitle(Fraction) xtitle(Area(acres)) plotregion(ilcolor(black) ilpattern(vshortdash))   
    graph save ownedarea_`d'.gph, replace
    local i = `i' + 1
}
graph combine ownedarea_1.gph ownedarea_2.gph, cols(2)
graph export "ownedarea.png", replace width(2000)

local colors "blue%40 teal%60"
local titles "Palakkad Thrissur"
local i = 1        
foreach d of numlist 1/2 {
    local color : word `i' of `colors'
    local title : word `i' of `titles'
    spikeplot leasedin_landarea_acre if district_mod == `d', fraction color(`color') lpattern(solid) title(`"{bf:`title'}"' ) lwidth(vthick) scheme(white_brbg) ytitle(Fraction) xtitle(Area(acres)) plotregion(ilcolor(black) ilpattern(vshortdash))   
    graph save leasedarea_`d'.gph, replace
    local i = `i' + 1
}
graph combine leasedarea_1.gph leasedarea_2.gph, cols(2)
graph export "leasedarea.png", replace width(2000)
<</dd_do>>
<div>
 <div style="display: flex; justify-content: center; align-items: flex-start; gap: 40px;">
   <img src="ownedarea.png" alt="Distribution of owned agricultural land by district" width="500">
   <img src="leasedarea.png" alt="Distribution of owned agricultural land by district" width="500">
 </div>
</div>
      <<dd_do:nocommands nooutput >>
       sum Totalricearea_sum_acre,detail
       local Paddyarea_mean = string(r(mean), "%9.2f")
       local Paddyarea_sd = string(r(sd), "%9.2f")
       <</dd_do>>
<h4 style='text-align: left;'<strong>Gross cultivated area under Paddy</strong></h4

The average gross area under paddy,cultivated across padasekharams is <<dd_display:`Paddyarea_mean'>> acres, with a standard deviation of <<dd_display:`Paddyarea_sd'>> acres.The distribution is as follows:

<!-- Table container -->
  <div>
    <table border="1" style="border-collapse: collapse; width: 100%; text-align: center;">
      <thead style="background-color: #f2f2f2;">
        <tr>
          <th>District</th>
          <th>Gross paddy area across padasekharams(acres)</th>
        </tr>
      </thead>

        <<dd_do:nocommands >>
        foreach d in `districts' {
          qui su Totalricearea_sum_acre if district_mod == `d', meanonly
          local M = r(mean)
          local name : label (district_mod) `d'
          di "<tr><td>`name'</td><td>" %6.2f `M' "</td></tr>"
        }
     <</dd_do>>  
   </table>
 </div>
<<dd_do:nocommands nooutput >>
local colors "purple%40 red%60"
local titles "Palakkad Thrissur"
local i = 1        
foreach d of numlist 1/2 {
    local color : word `i' of `colors'
    local title : word `i' of `titles'
    spikeplot Totalricearea_sum_acre if district_mod == `d', fraction color(`color') lpattern(solid) title(`"{bf:`title'}"' ) lwidth(vthick) scheme(white_brbg) ytitle(Fraction) xtitle(Area(acres)) plotregion(ilcolor(black) ilpattern(vshortdash))   
    graph save Totalarea_`d'.gph, replace
    local i = `i' + 1
}
graph combine Totalarea_1.gph Totalarea_2.gph, cols(2)
graph export "Totalarea.png", replace width(2000)
<</dd_do>> 

 <div style="display: flex; justify-content: center; align-items: flex-start; gap: 40px;">
   <img src="Totalarea.png" alt="Distribution of total agricultural land by district" width="500">
 </div>

<!-- Area of the largest paddy parcel (acres)-->
<h4 style='text-align: left;'>Area of the largest paddy parcel cultivated</h4>   
 <<dd_do:nocommands nooutput >>
       use "LCAS.dta", clear
       sum virippu_ricearea_acre if virippu_ricearea_acre!=0,detail
       local V_mean = string(r(mean), "%9.2f")
       local V_sd = string(r(sd), "%9.2f")
       sum Mundak_ricearea_acre if Mundak_ricearea_acre!=0 ,detail
       local M_mean = string(r(mean), "%9.2f")
       local M_sd = string(r(sd), "%9.2f")
       sum puncha_ricearea_acre if puncha_ricearea_acre!=0,detail
       local P_mean = string(r(mean), "%9.2f")
       local P_sd = string(r(sd), "%9.2f")
       <</dd_do>>

<h5 style='text-align: left;'>Virippu</h5>

<p>Amongst those who cultivated,the average area of the largest paddy parcel cultivated in <b>Virippu</b> is <<dd_display:`V_mean'>> acres, with a standard deviation of <<dd_display:`V_sd'>> acres.The distribution is as follows:</p>

<!-- Graph of distribution (Virippu) -->
<<dd_do:nocommands nooutput >>
use "LCAS.dta", clear
local colors "navy%40 red%30"
local titles "Palakkad Thrissur"
local i = 1
foreach d of numlist 1/2 {
    * Pick color and title from the list
    local color : word `i' of `colors'
    local title : word `i' of `titles'
    spikeplot virippu_ricearea_acre if district_mod == `d' & virippu_ricearea_acre!=0, fraction color(`color') lpattern(solid) title(`"{bf:`title'}"' ) lwidth(vthick) scheme(white_brbg) ytitle(Fraction) xtitle(Area(acres)) plotregion(ilcolor(black) ilpattern(vshortdash))   
    graph save largestparcel_V_`d'.gph, replace
    local i = `i' + 1
}
graph combine largestparcel_V_1.gph, cols(2)
graph export "largestparcel_V.png", replace width(2000)
<</dd_do>>

<div style="text-align:center;">
   <img src="largestparcel_V.png" alt="Distribution of area under largest parcel by district" width="500">
</div>

<!-- Graph of distribution (Mundakan) -->
<h5 style='text-align: left;'>Mundakan</h5>
<p>Amongst those who cultivated, the average area of the largest paddy parcel cultivated in <b>Mundakan</b> is <<dd_display:`M_mean'>> acres, with a standard deviation of <<dd_display:`M_sd'>> acres.The distribution is as follows:</p>

<<dd_do:nocommands nooutput >>
local colors "green%40 maroon%30"
local titles "Palakkad Thrissur"
local i = 1        
foreach d of numlist 1/2 {
    local color : word `i' of `colors'
    local title : word `i' of `titles'
    spikeplot Mundak_ricearea_acre if district_mod == `d' & Mundak_ricearea_acre!=0 , fraction color(`color') lpattern(solid) title(`"{bf:`title'}"' ) lwidth(vthick) scheme(white_brbg) ytitle(Fraction) xtitle(Area(acres)) plotregion(ilcolor(black) ilpattern(vshortdash))   
    graph save largestparcel_M_`d'.gph, replace
    local i = `i' + 1
}
graph combine largestparcel_M_1.gph largestparcel_M_2.gph, cols(2)
graph export "largestparcel_M.png", replace width(2000)
<</dd_do>>
<div style="text-align:center;">
   <img src="largestparcel_M.png" alt="Distribution of area under largest parcel by district" width="500">
</div>

<!-- Graph of distribution (Puncha) -->
<h5 style='text-align: left;'>Puncha</h5>
<p>Amongst those who cultivate, average area of the largest paddy parcel cultivated in <b>Puncha</b> is <<dd_display:`P_mean'>> acres, with a standard deviation of <<dd_display:`P_sd'>> acres.The distribution is as follows:</p>

<<dd_do:nocommands nooutput >>
local colors "orange%40 purple%30"
local titles "Palakkad Thrissur"
local i = 1  
foreach d of numlist 1/2 {
    local color : word `i' of `colors'
    local title : word `i' of `titles'
    spikeplot puncha_ricearea_acre if district_mod == `d' & puncha_ricearea_acre!=0 , fraction color(`color') lpattern(solid) title(`"{bf:`title'}"' ) lwidth(vthick) scheme(white_brbg) ytitle(Fraction) xtitle(Area(acres)) plotregion(ilcolor(black) ilpattern(vshortdash))   
    graph save largestparcel_P_`d'.gph, replace
    local i = `i' + 1
}
graph combine largestparcel_P_1.gph largestparcel_P_2.gph, cols(2)
graph export "largestparcel_P.png", replace width(2000)
<</dd_do>>

<div style="text-align:center;">
   <img src="largestparcel_P.png" alt="Distribution of area under largest parcel by district" width="500">
</div>

<!-- Table container -->
<div style="display: flex; flex-direction: column; gap: 20px;">
<div>
<table border="1" style="border-collapse: collapse; width: 100%; text-align: center;">
  <thead style="background-color: #f2f2f2;">
    <tr>
      <th>District</th>
      <th>Virippu (acres)</th>
      <th>Mundakan (acres)</th>
      <th>Puncha (acres)</th>
    </tr>
  </thead>

  <<dd_do:nocommands nooutput >>

    use "LCAS.dta", clear
    collapse (mean) Virippu_area = virippu_ricearea_acre if ricecult_virripu==1, by(district_mod)
    tempfile virippu
    save `virippu'
    use "LCAS.dta", clear
    collapse (mean) mundakan_area = Mundak_ricearea_acre if ricecult_mundak==1, by(district_mod)
    tempfile mundak
    save `mundak'
    use "LCAS.dta", clear
    collapse (mean) puncha_area = puncha_ricearea_acre if ricecult_puncha ==1, by(district_mod)
    tempfile puncha
    save `puncha'
    use `virippu', clear
    merge 1:1 district_mod using `mundak'
    drop _merge
    merge 1:1 district_mod using `puncha'
    drop _merge
    levelsof district_mod, local(districts)
     <</dd_do>>
    <<dd_do:nocommands >>
    foreach d of local districts {
        local name : label (district_mod) `d'

        quietly su Virippu_area if district_mod==`d', meanonly
        local V = cond(r(N)>0, string(r(mean), "%6.2f"), "0.00")

        quietly su mundakan_area if district_mod==`d', meanonly
        local M = cond(r(N)>0, string(r(mean), "%6.2f"), "0.00")

        quietly su puncha_area if district_mod==`d', meanonly
        local P = cond(r(N)>0, string(r(mean), "%6.2f"), "0.00")

        di "<tr><td>`name'</td><td>`V'</td><td>`M'</td><td>`P'</td></tr>"
    }
  <</dd_do>>
</table>
</div>
</div>
<!-- Location of the largest parcel of and under paddy-->
<h4 style='text-align: left;'<strong>Location of the largest parcel of land under Paddy</strong></h4
   
<<dd_do:nocommands nooutput >>
       use "LCAS.dta",clear
       spikeplot Plot_location if district_mod ==1, fraction color(cyan%50) lpattern(solid) title("{bf:Palakkad}") lwidth (vthick) scheme(white_brbg) ytitle (Fraction) xtitle(Location of the plot (metres))plotregion(ilcolor(black) ilpattern(vshortdash))
     graph save Plotloc_PKD.gph, replace
     spikeplot Plot_location if district_mod == 2, fraction color(green%30) lpattern(solid) title("{bf:Thrissur}") lwidth (vthick) scheme(white_brbg) ytitle(Fraction) xtitle(Location of the plot (metres)) plotregion(ilcolor(black) ilpattern(vshortdash))
     graph save Plotloc_TSR.gph, replace
     graph combine Plotloc_PKD.gph Plotloc_TSR.gph, cols(2)
     graph export "Plot_location.png", replace width(1800)
     sum Plot_location,detail
       <</dd_do>>

The average distance of the largest paddy parcel from the field canal is  <<dd_display: %6.2f `r(mean)'>> metres, with a standard deviation of <<dd_display: %6.2f `r(sd)'>> metres.The distribution of the location of these parcels as measured as distance from the field canal (metres) is as follows:

<!-- Side-by-side layout container -->
<div style="display: flex; justify-content: center; align-items: flex-start; gap: 40px;">
  <!-- Image container -->
  <div>
   <img src="Plot_location.png" alt="Distribution of plot locations by district" width="500">
  </div>
  <!-- Table container -->
 <div style="display: flex; flex-direction: column; gap: 20px;margin-top: 100px;">
 <div>
    <table border="1" style="border-collapse: collapse; width: 100%; text-align: center;">
      <thead style="background-color: #f2f2f2;">
        <tr>
          <th>District</th>
          <th>Distance from the field canal(metres)</th>
        </tr>
      </thead>
        <<dd_do:nocommands >>
        foreach d in `districts' {
          qui su Plot_location if district_mod == `d', meanonly
          local Loc_P = r(mean)
          local name : label (district_mod) `d'
          di "<tr><td>`name'</td><td>" %6.2f `Loc_P' "</td></tr>"
        }
     <</dd_do>>  
   </table>
 </div>
 </div>
</div>
</div>
<!-- SUBSECTION  5:Production Details -->
<div id="production" class="tab-content">
<h4 id="production" style="color:darkblue;margin-top:5px;"><strong>Production Details</strong></h4> 

Please click on the relevant sub-section tabs to read further details under production. 

<!-- Subtab header area (colored background) -->
<div id="productionSubtabsArea" class="production-subtab-area">
      <button class="sub-tab-link" data-target="season" onclick="openSubTab(event,'season')">üåæCrop seasons</button>
      <button class="sub-tab-link" data-target="cropest" onclick="openSubTab(event,'cropest')">üöú Crop establishment</button>
      <button class="sub-tab-link" data-target="nutrient" onclick="openSubTab(event,'nutrient')">üõçÔ∏èNutrient management</button>
      <button class="sub-tab-link" data-target="pest" onclick="openSubTab(event,'pest')">üêõPest & weed control</button>
      <button class="sub-tab-link" data-target="irrigation" onclick="openSubTab(event,'water')">üíßWater management</button>
      <button class="sub-tab-link" data-target="yield" onclick="openSubTab(event,'yield')">üßë‚ÄçüåæHarvesting</button>
    </div>

<div id="season" class="sub-tab-content">
<!--Season of cultivation-->
<<dd_do:nocommands nooutput >>
use "LCAS.dta", clear
local varlist ricecult_virripu ricecult_mundak ricecult_puncha  

* Temporary file to store the combined result 
tempfile Season_data
 
foreach var of local varlist {
   restore
   preserve
        contract district_mod `var'
        bysort district_mod (`var'): gen total = sum(_freq)
        bysort district_mod (`var'): replace total = total[_N]
        bysort district_mod (`var'): gen percent = 100 * _freq / total
        replace percent = round(percent,0.01)
        drop _freq total
        reshape wide percent, i(district_mod) j(`var')
        keep district_mod percent1
        rename percent1 percent1_`var'
        tempfile tmp
        save `tmp'

    * Merge into Season_data
    capture confirm file `Season_data'
    if _rc != 0 {
        * first dataset
        use `tmp', clear
        save `Season_data', replace
    }
    else {
        use `Season_data', clear
        merge 1:1 district_mod using `tmp'
        drop _merge
        save `Season_data', replace
    }
}
* Final combined dataset after loop
use `Season_data', clear

tempfile htmlout
file open outfile using `htmlout', write replace
file write outfile "<table border='1' style='border-collapse: collapse; width: 75%; font-size:100%; text-align: center;'>" _n
file write outfile "<tr style='background-color:#f2f2f2;'><th>District</th><th>Virippu (%)</th><th>Mundakan (%)</th><th>Puncha (%)</th></tr>" _n
levelsof district_mod, local(districts)
<</dd_do>>

<h4 style='text-align: left;'>Season of cultivation</h4>
The proportion of respondents cultivating paddy in each season is as follows:

<<dd_do:nocommands>>
foreach d of local districts {
    quietly su percent1_ricecult_virripu if district_mod == `d', meanonly
    local p1 = string(r(mean), "%9.2f")
    quietly su percent1_ricecult_mundak if district_mod == `d', meanonly
    local p2 = string(r(mean), "%9.2f")
    quietly su percent1_ricecult_puncha if district_mod == `d', meanonly
    local p3 = string(r(mean), "%9.2f")
    local name : label (district_mod) `d'
    file write outfile "<tr><td>`name'</td><td>`p1'</td><td>`p2'</td><td>`p3'</td></tr>" _n
}

file write outfile "</table>" _n
file close outfile
type `htmlout'
<</dd_do>>
</div>

<div id="cropest" class="sub-tab-content">

<div class="green-note">
  The following subsections present averages and tabulations for respondents who cultivated in that particular season.
</div>

<!--Top 3 Varieties grown-->
<<dd_do:nocommands nooutput>>
use "LCAS.dta", clear

local varietyvars virippu_variety mundak_variety puncha_variety 
local graphnames V_Variety M_Variety P_Variety 
local seasons ricecult_virripu ricecult_mundak ricecult_puncha
local endnames Virippu Mundakan Puncha
local nvars : word count `varietyvars'

tempfile origdata
save `origdata', replace

forval i = 1/`nvars' {
    use `origdata', clear

    local var : word `i' of `varietyvars'
    local gname : word `i' of `graphnames'
    local ename : word `i' of `endnames'
    local sname : word `i' of `seasons'

    * Keep only observations for the current season
    keep if `sname' == 1

    * Count observations by variety and district using contract
    contract `var' district_mod
    rename _freq count

    * Calculate total counts per district
    bysort district_mod: egen total = total(count)

    * Calculate percent
    gen percent = (count / total) * 100

    * Drop entries with var == 9998 if you want to exclude those from graphs
    drop if `var' == 9998

    tempfile fulldata
    save `fulldata', replace

    * Get list of districts for this season
    levelsof district_mod, local(districts)
    local gphlist ""

    * Loop over each district
    foreach d of local districts {
        use `fulldata', clear
        keep if district_mod == `d'
        if _N == 0 continue

        gsort -percent
        gen rank = _n
        keep if rank <= 3
        if _N == 0 continue

        capture local dname : label (district_mod) `d'
        if _rc local dname = "`d'"
      
        local seasoncolors "pink%70 green%70 blue%70"
        local color : word `i' of `seasoncolors'

    graph bar percent, over(`var',sort(1) descending label(angle(vertical))) ///
    title("{bf:Choice of paddy varieties:`dname'}", size(medlarge)) ///
    bar(1, color(`color')) blabel(bar, format(%5.1f)) ///
    scheme(white_brbg) plotregion(ilcolor(black) ilpattern(vshortdash)) ///
    name("`gname'_`d'", replace)

        local fname = "`gname'_`d'"
        graph save "`fname'.gph", replace
        graph drop "`fname'" 
        local gphlist "`gphlist' `fname'.gph"
    }

    * Combine district graphs and export
    local ngraphs : word count `gphlist'
    if `ngraphs' > 0 {
        if `ngraphs' == 1 {
            local first : word 1 of `gphlist'
            graph use "`first'", name(tmp, replace)
            graph export "`gname'.png", replace width(2000) height(1500)
            graph drop tmp
        }
        else {
            graph combine `gphlist', cols(2) name(combined_`gname', replace)
            graph export "`gname'.png", replace width(2000) height(1500)
            graph drop combined_`gname'
        }
    }
    else {
        di as error "No graphs created for `var'"
    }
}

use "LCAS.dta", clear
<</dd_do>>

<h4 style='text-align: left;'>Choice of varieties</h4>
The three topmost varietal choices in each season is as follows:

 <!-- Image container -->
  <div style="text-align: center;">
    <h5 style='text-align: left;'>Virippu</h5>
    <img src="V_Variety.png" alt="Variety by district" width="500">
    <h5 style='text-align: left;'>Mundakan</h5>
   <img src="M_Variety.png" alt="Variety by district" width="700">
   <h5 style='text-align: left;'>Puncha</h5>
   <img src="P_Variety.png" alt="Variety by district" width="700">
  </div>


<!--Seed rate-->
<h4 style="text-align: left;"><strong>Seed rate</strong></h4>

<<dd_do:nocommands nooutput>>
use "LCAS.dta", clear
local seedvars   virippu_seedrate_acre mundak_seedrate_acre puncha_seedrate_acre 
local cultvars   ricecult_virripu      ricecult_mundak      ricecult_puncha 
local seasons    Virippu               Mundakan             Puncha
local seedcolors maroon%60             forest_green%40      purple%40

levelsof district_mod, local(districts)
local n : word count `seedvars'
<</dd_do>>
<<dd_do:nocommands>>
forvalues i = 1/`n' {
    local ratevar   : word `i' of `seedvars'
    local cultlist  : word `i' of `cultvars'
    local season    : word `i' of `seasons'
    local thiscolor : word `i' of `seedcolors'

    quietly {
        restore
        preserve
        keep if `cultlist' == 1

        quietly sum `ratevar', detail
        local meanval = string(r(mean), "%9.2f")
        local sdval   = string(r(sd), "%9.2f")

        local gphlist

        foreach d of local districts {
            capture confirm numeric variable district_mod
            if _rc == 0 {
                quietly count if district_mod == `d'
                if r(N) == 0 continue
                local dname : label (district_mod) `d'
            }
            else {
                quietly count if district_mod == "`d'"
                if r(N) == 0 continue
                local dname "`d'"
            }

            quietly spikeplot `ratevar' if district_mod == `d', ///
                fraction color(`thiscolor') lpattern(solid) ///
                title("{bf:`dname'}") lwidth(vthick) scheme(white_brbg) ///
                ytitle(Fraction) xtitle("Seed rate (kg/acre)") ///
                plotregion(ilcolor(black) ilpattern(vshortdash))

            local gphname "`ratevar'_d`d'.gph"
            quietly graph save "`gphname'", replace
            local gphlist `gphlist' "`gphname'"
        }

        if "`gphlist'" != "" {
            quietly graph combine `gphlist', cols(2) iscale(.8)
            quietly graph export "`season'_seedrate.png", replace width(1800)
        }
    }

    // Output only clean HTML lines to dyndoc
    di as txt "<h5 style='text-align: left;'>"  "`season'"  "</h5>"
    di as txt "<p style='text-align:left;'>The average seed rate application for " "`season'" " is " "`meanval'" " kg/acre, with a standard deviation of " "`sdval'" " kg/acre. </p>"
    di as txt "<div style='text-align:center;'>"
    di as txt "<img src='" "`season'_seedrate.png" "' alt='Seedrate by district' width='700'>"
    di as txt "</div>"
}
<</dd_do>>


<!--Age of seedling-->
<h4 style="text-align: left;"><strong>Age of seedling transplanted</strong></h4>

<<dd_do:nocommands nooutput>>
use "LCAS.dta", clear
local seedvars   virippu_seedling       mundak_seedling     puncha_seedling 
local cultvars   ricecult_virripu      ricecult_mundak      ricecult_puncha 
local seasons    Virippu               Mundakan             Puncha
local cropest    virippu_transpl_YN mundak_transpl_YN puncha_transpl_YN
local seedcolors cyan%60             forest_green%40      teal%70

levelsof district_mod, local(districts)
local n : word count `seedvars'
<</dd_do>>
<<dd_do:nocommands>>
forvalues i = 1/`n' {
    local ratevar   : word `i' of `seedvars'
    local cultlist  : word `i' of `cultvars'
    local season    : word `i' of `seasons'
    local thiscolor : word `i' of `seedcolors'
    local cest      : word `i' of `cropest'

    quietly {
        restore
        preserve
        keep if `cultlist' == 1 & `cest'== 1
        quietly sum `ratevar', detail
        local meanval = string(r(mean), "%9.2f")
        local sdval   = string(r(sd), "%9.2f")

        local gphlist

        foreach d of local districts {
            capture confirm numeric variable district_mod
            if _rc == 0 {
                quietly count if district_mod == `d'
                if r(N) == 0 continue
                local dname : label (district_mod) `d'
            }
            else {
                quietly count if district_mod == "`d'"
                if r(N) == 0 continue
                local dname "`d'"
            }

            quietly spikeplot `ratevar' if district_mod == `d', ///
                fraction color(`thiscolor') lpattern(solid) ///
                title("{bf:`dname'}") lwidth(vthick) scheme(white_brbg) ///
                ytitle(Fraction) xtitle("Age of seedling transplanted (days)") ///
                plotregion(ilcolor(black) ilpattern(vshortdash))

            local gphname "`ratevar'_d`d'.gph"
            quietly graph save "`gphname'", replace
            local gphlist `gphlist' "`gphname'"
        }

        if "`gphlist'" != "" {
            quietly graph combine `gphlist', cols(2) iscale(.8)
            quietly graph export "`season'_seedrate.png", replace width(1800)
        }
    }

    // Output only clean HTML lines to dyndoc
    di as txt "<h5 style='text-align: left;'>"  "`season'"  "</h5>"
    di as txt "<p style='text-align:left;'>The average age of seedling when transplanted in " "`season'" " is " "`meanval'" " days, with a standard deviation of " "`sdval'" " days. </p>"
    di as txt "<div style='text-align:center;'>"
    di as txt "<img src='" "`season'_seedrate.png" "' alt='Seedlingage by district' width='700'>"
    di as txt "</div>"
}
<</dd_do>>

<!-- Seed treatment -->
<h4 style='text-align: left;'>Seed treatment</h4> 

The proportion of respondents choosing to follow seedtreatment in each season is as follows:

<<dd_do:nocommands nooutput >>
use "LCAS.dta", clear

*---------------------------------------------------
* 1. Define seed treatment and cultivation pairs
*---------------------------------------------------
local preplist virippu_seedtrt mundak_seedtrt puncha_seedtrt 
local cultlist ricecult_virripu ricecult_mundak ricecult_puncha

* Temporary file to store the combined result
tempfile Season_data

*---------------------------------------------------
* 2. Loop through each seed treatment variable
*---------------------------------------------------
local n : word count `preplist'
forvalues i = 1/`n' {
    
    local prepvar : word `i' of `preplist'
    local cultvar : word `i' of `cultlist'
    restore
    preserve
        * Keep only cultivated cases for this season
        keep if `cultvar' == 1
        
        * Count applications by district
        contract district_mod `prepvar'
        
        * Compute total plots per district
        by district_mod (`prepvar'), sort: gen total = sum(_freq)
        by district_mod (`prepvar'), sort: replace total = total[_N]
        
        * Compute percentages
        gen percent = 100 * _freq / total
        replace percent = round(percent,0.01)
        drop _freq total
        
        * Reshape to wide format for this prep variable
        reshape wide percent, i(district_mod) j(`prepvar')
        
        * Drop unnecessary percent columns if exist
        capture drop percent9998
        capture drop percent2
        
        * Rename columns with prepvar suffix
        rename percent* percent*_`prepvar'
        foreach v of varlist percent*_`prepvar' {
    replace `v' = 0 if missing(`v')
}

        * Save temporary result
        tempfile tmp
        save `tmp'

        * Merge into cumulative Season_data
        capture confirm file `Season_data'
        if _rc != 0 {
            * First dataset
            use `tmp', clear
            save `Season_data', replace
        }
        else {
            use `Season_data', clear
            merge 1:1 district_mod using `tmp'
            drop _merge
            save `Season_data', replace
        }
}
<</dd_do>>

<div>
<table border="1" style="border-collapse: collapse; width: 50%; text-align: center;">
  <thead style="background-color: #f2f2f2;">
    <tr>
      <th>District</th>
      <th>Virippu (%)</th>
      <th>Mundakan (%)</th>
      <th>Puncha (%)</th>
    </tr>
  </thead>

<<dd_do:nocommands nooutput>>
use `Season_data', clear
levelsof district_mod, local(districts)
<</dd_do>>
<<dd_do:nocommands >>
foreach d of local districts {
    quietly su percent1_virippu_seedtrt if district_mod == `d', meanonly
    local p1 = string(r(mean), "%9.2f")
    quietly su percent1_mundak_seedtrt if district_mod == `d', meanonly
    local p2 = string(r(mean), "%9.2f")
    quietly su percent1_puncha_seedtrt if district_mod == `d', meanonly
    local p3 = string(r(mean), "%9.2f")
    capture local name : label (district_mod) `d'
    if _rc != 0 local name = string(`d')
    di "<tr><td>`name'</td><td>`p1'</td><td>`p2'</td><td>`p3'</td></tr>" 
}
<</dd_do>>
</table>
</div>


<!--Crop establishment method-->
<h4 style='text-align: left;'>Crop establishment method</h4> 

The choice of crop establishment method by the respondents in each season is as follows:

<<dd_do:nocommands nooutput >>
use "LCAS.dta", clear
*---------------------------------------------------
* 1. Define crop establishment and cultivation pairs
*---------------------------------------------------
local estlist  virippu_cestabl mundak_cestabl puncha_cestabl
local cultlist ricecult_virripu ricecult_mundak ricecult_puncha

* Temporary file to store the combined result
tempfile Season_data

*---------------------------------------------------
* 2. Loop through each crop establishment variable
*---------------------------------------------------
local n : word count `estlist'
forvalues i = 1/`n' {
    
    local estvar : word `i' of `estlist'
    local cultvar : word `i' of `cultlist'
    
    restore
    preserve
        * Keep only cultivated cases for this season
        keep if `cultvar' == 1
        
        contract district_mod `estvar'
        by district_mod (`estvar'), sort: gen total = sum(_freq)
        by district_mod (`estvar'), sort: replace total = total[_N]
        gen percent = 100 * _freq / total
        replace percent = round(percent,0.01)
        drop _freq total
        reshape wide percent, i(district_mod) j(`estvar')
        capture confirm var percent9998
        if _rc == 0 {
        drop percent9998
         }
        rename percent* percent*_`estvar'

        * Save temporary result
        tempfile tmp
        save `tmp'

    * Merge into cumulative Season_data
    capture confirm file `Season_data'
    if _rc != 0 {
        * First dataset
        use `tmp', clear
        save `Season_data', replace
    }
    else {
        use `Season_data', clear
        merge 1:1 district_mod using `tmp'
        drop _merge
        save `Season_data', replace
    }
}

*---------------------------------------------------
*Final dataset after loop (Virippu)
*---------------------------------------------------
use `Season_data', clear

* Prepare HTML output file
tempfile htmlout
file open outfile using `htmlout', write replace
file write outfile "<table border='1' style='border-collapse: collapse; width: 75%; font-size:100%; text-align: center;'>" _n
file write outfile "<h5 style='text-align: left;'>Virippu</h5>" _n
file write outfile "<tr style='background-color:#f2f2f2;'><th>District</th><th>Manual transplanting (random) (%)</th><th> Manual transplanting (line) (%)</th><th>Mechanical transplanting (%)</th><th>Hand broadcasting (%)</th><th> Wet direct seeding (%)</th></tr>" _n

levelsof district_mod, local(districts)
foreach d of local districts {
    local name : label (district_mod) `d'
    local row "<tr><td>`name'</td>"
        unab vars : percent*_virippu_cestabl
        foreach v of local vars {
            quietly su `v' if district_mod == `d', meanonly
            local meanval = cond(r(N)>0, string(r(mean), "%6.2f"), "0.00")
            local row "`row'<td>`meanval'</td>"
  }
     file write outfile "`row'</tr>" _n
 }
<</dd_do>>
<<dd_do:nocommands>>
file write outfile "</table>" _n
file close outfile
type `htmlout'
<</dd_do>>

<<dd_do:nocommands nooutput >>
*---------------------------------------------------
* Final dataset after loop (Mundakan)
*---------------------------------------------------
use `Season_data', clear

* Prepare HTML output file
tempfile htmlout
file open outfile using `htmlout', write replace
file write outfile "<table border='1' style='border-collapse: collapse; width: 75%; font-size:100%; text-align: center;'>" _n
file write outfile "<h5 style='text-align: left;'>Mundakan</h5>" _n
file write outfile "<tr style='background-color:#f2f2f2;'><th>District</th><th>Manual transplanting (random) (%)</th><th> Manual transplanting (line) (%)</th><th>Mechanical transplanting (%)</th><th>Hand broadcasting (%)</th><th> Wet direct seeding (%)</th></tr>" _n

levelsof district_mod, local(districts)
foreach d of local districts {
    local name : label (district_mod) `d'
    local row "<tr><td>`name'</td>"
        unab vars : percent*_mundak_cestabl
        foreach v of local vars {
            quietly su `v' if district_mod == `d', meanonly
            local meanval = cond(r(N)>0, string(r(mean), "%6.2f"), "0.00")
            local row "`row'<td>`meanval'</td>"
 }
       file write outfile "`row'</tr>" _n
}
<</dd_do>>
<<dd_do:nocommands>>
file write outfile "</table>" _n
file close outfile
type `htmlout'
<</dd_do>>

<<dd_do:nocommands nooutput >>
*---------------------------------------------------
* Final dataset after loop (Puncha)
*---------------------------------------------------
use `Season_data', clear

* Prepare HTML output file
tempfile htmlout
file open outfile using `htmlout', write replace
file write outfile "<table border='1' style='border-collapse: collapse; width: 75%; font-size:100%; text-align: center;'>" _n
file write outfile "<h5 style='text-align: left;'>Puncha</h5>" _n
file write outfile "<tr style='background-color:#f2f2f2;'><th>District</th><th>Manual transplanting (random) (%)</th><th> Manual transplanting (line) (%)</th><th>Mechanical transplanting (%)</th><th>Hand broadcasting (%)</th><th> Wet direct seeding (%)</th></tr>" _n

levelsof district_mod, local(districts)
foreach d of local districts {
    local name : label (district_mod) `d'
    local row "<tr><td>`name'</td>"
        unab vars : percent*_puncha_cestabl
        foreach v of local vars {
            quietly su `v' if district_mod == `d', meanonly
            local meanval = cond(r(N)>0, string(r(mean), "%6.2f"), "0.00")
            local row "`row'<td>`meanval'</td>"
  }
     file write outfile "`row'</tr>" _n
}
<</dd_do>>
<<dd_do:nocommands>>
file write outfile "</table>" _n
file close outfile
type `htmlout'
<</dd_do>>

<!-- Day of transplanting -->
<h4 style='text-align: left;'>Day of transplanting</h4> 
<<dd_do:nocommands nooutput >>
use "LCAS.dta", clear

* Seasons, corresponding day vars, cultivation flags, and titles
local seasons virippu mundak puncha
local dayvars Day_virippu_DOT Day_mund_DOT Day_puncha_DOT
local titles  Virippu Mundakan Puncha
local cult    ricecult_virripu ricecult_mundak ricecult_puncha

* District list and labels
local districts 1 2
local dnames Palakkad Thrissur
local colors lavender%40 brown%20

local n : word count `seasons'
forvalues i = 1/`n' {
    local season : word `i' of `seasons'
    local dayvar : word `i' of `dayvars'
    local title  : word `i' of `titles'
    local cultlist : word `i' of `cult'
    
    restore
    preserve
    keep if `cultlist' == 1
    
    local plotparts
    local nd : word count `districts'
    forvalues j = 1/`nd' {
        local d = `: word `j' of `districts''
        local dname : word `j' of `dnames'
        local col : word `j' of `colors'

        quietly count if district_mod == `d' & !missing(`dayvar')
        if r(N) > 0 {
            * Actual density plot
            local plotparts `plotparts' ///
                (kdensity `dayvar' if district_mod == `d', ///
                    recast(spike) lcolor(`col') lpattern(solid) ///
                    legend(label(`j' "`dname': Transplanting day")))
        }
        else {
            * Invisible dummy plot so legend slot remains
            local plotparts `plotparts' ///
                (function y=., range(0 1) lcolor(`col') lpattern(solid) ///
                    legend(label(`j' "`dname': No data")))
        }
    }

    twoway `plotparts', ///
        xlabel(#5) scheme(white_brbg) ///
        ytitle(Density) xtitle(Julian days) ///
        subtitle("{bf:`title'}") ///
        legend(on order(1 2) position(1) ring(0)) ///
        name(`season', replace)
    graph export "`season'_transplanting.png", replace width(1400) height(900)
    graph drop `season'
}
<</dd_do>>
The temporal distribution of transplanting dates for each season is shown below:

<div style="text-align:center; margin-bottom:20px;">
  <img src="virippu_transplanting.png" alt="Virippu transplanting dates" width="500">
  <img src="mundak_transplanting.png" alt="Mundak transplanting dates" width="500">
  <img src="puncha_transplanting.png" alt="Puncha transplanting dates" width="500">
</div>

<!--Land preparation-->
<h4 style='text-align: left;'>Land preparation method</h4> 
The choice of land preparation method by the respondents in each season is as follows:
<<dd_do:nocommands nooutput >>
use "LCAS.dta", clear
*---------------------------------------------------
* 1. Define land preparation and cultivation pairs
*---------------------------------------------------
local preplist  virippu_landprep mundak_landprep puncha_landprep
local cultlist ricecult_virripu ricecult_mundak ricecult_puncha

* Temporary file to store the combined result
tempfile Season_data

*---------------------------------------------------
* 2. Loop through each landprep variable
*---------------------------------------------------
local n : word count `preplist'
forvalues i = 1/`n' {
    
    local prepvar : word `i' of `preplist'
    local cultvar : word `i' of `cultlist'
   
    restore
    preserve
        * Keep only cultivated cases for this season
        keep if `cultvar' == 1
        
        contract district_mod `prepvar'
        by district_mod (`prepvar'), sort: gen total = sum(_freq)
        by district_mod (`prepvar'), sort: replace total = total[_N]
        gen percent = 100 * _freq / total
        replace percent = round(percent,0.01)
        drop _freq total
        reshape wide percent, i(district_mod) j(`prepvar')
        capture confirm var percent9998
        if _rc == 0 {
        drop percent9998
         }
        rename percent* percent*_`prepvar'

        * Save temporary result
        tempfile tmp
        save `tmp'

    * Merge into cumulative Season_data
    capture confirm file `Season_data'
    if _rc != 0 {
        * First dataset
        use `tmp', clear
        save `Season_data', replace
    }
    else {
        use `Season_data', clear
        merge 1:1 district_mod using `tmp'
        drop _merge
        save `Season_data', replace
    }
}

*---------------------------------------------------
*Final dataset after loop (Virippu)
*---------------------------------------------------
use `Season_data', clear

* Prepare HTML output file
tempfile htmlout
file open outfile using `htmlout', write replace
file write outfile "<table border='1' style='border-collapse: collapse; width: 75%; font-size:100%; text-align: center;'>" _n
file write outfile "<h5 style='text-align: left;'>Virippu</h5>" _n
file write outfile "<tr style='background-color:#f2f2f2;'><th>District</th><th>Ploughing & Puddling (%)</th><th> Ploughing & Harrowing (%)</th><th>Laser leveling(%)</th></tr>" _n

levelsof district_mod, local(districts)
foreach d of local districts {
    local name : label (district_mod) `d'
    local row "<tr><td>`name'</td>"
        unab vars : percent*_virippu_landprep
        foreach v of local vars {
            quietly su `v' if district_mod == `d', meanonly
            local meanval = cond(r(N)>0, string(r(mean), "%6.2f"), "0.00")
            local row "`row'<td>`meanval'</td>"
  }
     file write outfile "`row'</tr>" _n
 }
<</dd_do>>
<<dd_do:nocommands>>
file write outfile "</table>" _n
file close outfile
type `htmlout'
<</dd_do>>

<<dd_do:nocommands nooutput >>
*---------------------------------------------------
* Final dataset after loop (Mundakan)
*---------------------------------------------------
use `Season_data', clear

* Prepare HTML output file
tempfile htmlout
file open outfile using `htmlout', write replace
file write outfile "<table border='1' style='border-collapse: collapse; width: 75%; font-size:100%; text-align: center;'>" _n
file write outfile "<h5 style='text-align: left;'>Mundakan</h5>" _n
file write outfile "<tr style='background-color:#f2f2f2;'><th>District</th><th>Ploughing & Puddling (%)</th><th> Ploughing & Harrowing (%)</th><th>Laser leveling(%)</th></tr>" _n

levelsof district_mod, local(districts)
foreach d of local districts {
    local name : label (district_mod) `d'
    local row "<tr><td>`name'</td>"
        unab vars : percent*_mundak_landprep
        foreach v of local vars {
            quietly su `v' if district_mod == `d', meanonly
            local meanval = cond(r(N)>0, string(r(mean), "%6.2f"), "0.00")
            local row "`row'<td>`meanval'</td>"
 }
       file write outfile "`row'</tr>" _n
}
<</dd_do>>
<<dd_do:nocommands>>
file write outfile "</table>" _n
file close outfile
type `htmlout'
<</dd_do>>

<<dd_do:nocommands nooutput >>
*---------------------------------------------------
* Final dataset after loop (Puncha)
*---------------------------------------------------
use `Season_data', clear

* Prepare HTML output file
tempfile htmlout
file open outfile using `htmlout', write replace
file write outfile "<table border='1' style='border-collapse: collapse; width: 75%; font-size:100%; text-align: center;'>" _n
file write outfile "<h5 style='text-align: left;'>Puncha</h5>" _n
file write outfile "<tr style='background-color:#f2f2f2;'><th>District</th><th>Ploughing & Puddling (%)</th><th> Ploughing & Harrowing (%)</th><th>Laser leveling(%)</th></tr>" _n

levelsof district_mod, local(districts)
foreach d of local districts {
    local name : label (district_mod) `d'
    local row "<tr><td>`name'</td>"
        unab vars : percent*_puncha_landprep
        foreach v of local vars {
            quietly su `v' if district_mod == `d', meanonly
            local meanval = cond(r(N)>0, string(r(mean), "%6.2f"), "0.00")
            local row "`row'<td>`meanval'</td>"
  }
     file write outfile "`row'</tr>" _n
}
<</dd_do>>
<<dd_do:nocommands>>
file write outfile "</table>" _n
file close outfile
type `htmlout'
<</dd_do>>
</div>

<div id="nutrient" class="sub-tab-content">
<!-- Organic manure application -->
<h4 style='text-align: left;'>Application of organic manure</h4> 

<div class="green-note">
  The following subsections present averages and tabulations for respondents who cultivated in that particular season.
</div>

The proportion of respondents choosing to apply organic manure in each season is as follows:

<<dd_do:nocommands nooutput >>
use "LCAS.dta", clear

*---------------------------------------------------
* 1. Define organic manure and cultivation pairs
*---------------------------------------------------
local preplist virippu_orgaamend mundak_orgaamend puncha_orgaamend
local cultlist ricecult_virripu ricecult_mundak ricecult_puncha

* Temporary file to store the combined result
tempfile Season_data

*---------------------------------------------------
* 2. Loop through each organic manure variable
*---------------------------------------------------
local n : word count `preplist'
forvalues i = 1/`n' {
    
    local prepvar : word `i' of `preplist'
    local cultvar : word `i' of `cultlist'
   
    restore
    preserve
        * Keep only cultivated cases for this season
        keep if `cultvar' == 1
        
        * Count applications by district
        contract district_mod `prepvar'
        
        * Compute total plots per district
        by district_mod (`prepvar'), sort: gen total = sum(_freq)
        by district_mod (`prepvar'), sort: replace total = total[_N]
        
        * Compute percentages
        gen percent = 100 * _freq / total
        replace percent = round(percent,0.01)
        drop _freq total
        
        * Reshape to wide format for this prep variable
        reshape wide percent, i(district_mod) j(`prepvar')
        
        * Drop unnecessary percent columns if exist
        capture drop percent9998
        capture drop percent2
        
        * Rename columns with prepvar suffix
        rename percent* percent*_`prepvar'
        foreach v of varlist percent*_`prepvar' {
    replace `v' = 0 if missing(`v')
}

        * Save temporary result
        tempfile tmp
        save `tmp'

        * Merge into cumulative Season_data
        capture confirm file `Season_data'
        if _rc != 0 {
            * First dataset
            use `tmp', clear
            save `Season_data', replace
        }
        else {
            use `Season_data', clear
            merge 1:1 district_mod using `tmp'
            drop _merge
            save `Season_data', replace
        }
}
<</dd_do>>

<div>
<table border="1" style="border-collapse: collapse; width: 50%; text-align: center;">
  <thead style="background-color: #f2f2f2;">
    <tr>
      <th>District</th>
      <th>Virippu (%)</th>
      <th>Mundakan (%)</th>
      <th>Puncha (%)</th>
    </tr>
  </thead>

<<dd_do:nocommands nooutput>>
use `Season_data', clear
levelsof district_mod, local(districts)
<</dd_do>>
<<dd_do:nocommands >>
foreach d of local districts {
    quietly su percent1_virippu_orgaamend if district_mod == `d', meanonly
    local p1 = string(r(mean), "%9.2f")
    quietly su percent1_mundak_orgaamend if district_mod == `d', meanonly
    local p2 = string(r(mean), "%9.2f")
    quietly su percent1_puncha_orgaamend if district_mod == `d', meanonly
    local p3 = string(r(mean), "%9.2f")
    capture local name : label (district_mod) `d'
    if _rc != 0 local name = string(`d')
    di "<tr><td>`name'</td><td>`p1'</td><td>`p2'</td><td>`p3'</td></tr>" 
}
<</dd_do>>
</table>
</div>

<!-- Second table: Types of Organic manure (Virippu) -->
<h4 style='text-align: left;'>Types of organic manure applied</h4> 
The proportion of respondents choosing to apply each type of organic manure in each season is as follows:

<!-- Types of Organic manure (Virippu) -->
<<dd_do:nocommands nooutput >>
use "LCAS.dta"
local preplist virippu_manure_1_YN virippu_manure_2_YN virippu_manure_3_YN virippu_manure_4_YN virippu_manure_5_YN

tempfile Season_data

local n : word count `preplist'
forvalues i = 1/`n' {
    local prepvar : word `i' of `preplist'

    capture confirm variable `prepvar'
    if _rc { 
        di as txt "Skipping: `prepvar' (variable not found)"
        continue
    }
    
    restore
    preserve
        keep if ricecult_virripu == 1
        contract district_mod `prepvar'
        
        by district_mod (`prepvar'), sort: gen total = sum(_freq)
        by district_mod (`prepvar'), sort: replace total = total[_N]
        
        gen percent = 100 * _freq / total
        replace percent = round(percent,0.01)
        drop _freq total
        
        reshape wide percent, i(district_mod) j(`prepvar')
        capture drop percent9998
        capture drop percent2
        
        rename percent* percent*_`prepvar'
        foreach v of varlist percent*_`prepvar' {
            replace `v' = 0 if missing(`v')
        }

        tempfile tmp
        save `tmp'

        capture confirm file `Season_data'
        if _rc != 0 {
            use `tmp', clear
            save `Season_data', replace
        }
        else {
            use `Season_data', clear
            merge 1:1 district_mod using `tmp'
            drop _merge
            save `Season_data', replace
        }
}

<</dd_do>>

<h5 style='text-align: left;'>Virippu</h5>

<div>
<table border="1" style="border-collapse: collapse; width: 50%; text-align: center;">
  <thead style="background-color: #f2f2f2;">
    <tr>
      <th>District</th>
      <th>Used farmyard manure (%)</th>
      <th> Used green manure (%)</th>
      <th>Used stubble (%)</th>
      <th>Used vermi compost (%)</th>
    </tr>
  </thead>

<<dd_do:nocommands nooutput>>
use `Season_data', clear
levelsof district_mod, local(districts)
<</dd_do>>
<<dd_do:nocommands >>
foreach d of local districts {
    capture confirm variable percent1_virippu_manure_1_YN
    if !_rc {
        quietly su percent1_virippu_manure_1_YN if district_mod == `d', meanonly
        local p1 = string(r(mean), "%9.2f")
    }
    else local p1 = "NA"

    capture confirm variable percent1_virippu_manure_2_YN
    if !_rc {
        quietly su percent1_virippu_manure_2_YN if district_mod == `d', meanonly
        local p2 = string(r(mean), "%9.2f")
    }
    else local p2 = "NA"

    capture confirm variable percent1_virippu_manure_3_YN
    if !_rc {
        quietly su percent1_virippu_manure_3_YN if district_mod == `d', meanonly
        local p3 = string(r(mean), "%9.2f")
    }
    else local p3 = "NA"

    capture confirm variable percent1_virippu_manure_4_YN
    if !_rc {
        quietly su percent1_virippu_manure_4_YN if district_mod == `d', meanonly
        local p4 = string(r(mean), "%9.2f")
    }
    else local p4 = "NA"

    capture local name : label (district_mod) `d'
    if _rc != 0 local name = string(`d')

    di "<tr><td>`name'</td><td>`p1'</td><td>`p2'</td><td>`p3'</td><td>`p4'</td></tr>"
}

* Now compute totals for all districts (overall)
capture confirm variable percent1_virippu_manure_1_YN
if !_rc {
    quietly su percent1_virippu_manure_1_YN, meanonly
    local p1S = string(r(mean), "%9.2f")
}
else local p1S = "NA"

capture confirm variable percent1_virippu_manure_2_YN
if !_rc {
    quietly su percent1_virippu_manure_2_YN, meanonly
    local p2S = string(r(mean), "%9.2f")
}
else local p2S = "NA"

capture confirm variable percent1_virippu_manure_3_YN
if !_rc {
    quietly su percent1_virippu_manure_3_YN, meanonly
    local p3S = string(r(mean), "%9.2f")
}
else local p3S = "NA"

capture confirm variable percent1_virippu_manure_4_YN
if !_rc {
    quietly su percent1_virippu_manure_4_YN, meanonly
    local p4S = string(r(mean), "%9.2f")
}
else local p4S = "NA"

di "<tr><td><strong>Total</strong></td><td>`p1S'</td><td>`p2S'</td><td>`p3S'</td><td>`p4S'</td></tr>"
<</dd_do>>
</table>
</div>

<!-- Types of Organic manure (Mundakan) -->
<<dd_do:nocommands nooutput >>
use "LCAS.dta"
local preplist mundak_manure_1_YN mundak_manure_2_YN mundak_manure_3_YN mundak_manure_4_YN mundak_manure_5_YN

tempfile Season_data

*---------------------------------------------------
*Loop through each organic manure variable (Mundakan)
*---------------------------------------------------
local n : word count `preplist'
forvalues i = 1/`n' {
    
    local prepvar : word `i' of `preplist'
    
    restore
    preserve
        * Keep only cultivated cases for this season
        keep if ricecult_mundak == 1
        
        * Count applications by district
        contract district_mod `prepvar'
        
        * Compute total plots per district
        by district_mod (`prepvar'), sort: gen total = sum(_freq)
        by district_mod (`prepvar'), sort: replace total = total[_N]
        
        * Compute percentages
        gen percent = 100 * _freq / total
        replace percent = round(percent,0.01)
        drop _freq total
        
        * Reshape to wide format for this prep variable
        reshape wide percent, i(district_mod) j(`prepvar')
        
        * Drop unnecessary percent columns if exist
        capture drop percent9998
        capture drop percent2
        
        * Rename columns with prepvar suffix
        rename percent* percent*_`prepvar'
        foreach v of varlist percent*_`prepvar' {
    replace `v' = 0 if missing(`v')
}

        * Save temporary result
        tempfile tmp
        save `tmp'

        * Merge into cumulative Season_data
        capture confirm file `Season_data'
        if _rc != 0 {
            * First dataset
            use `tmp', clear
            save `Season_data', replace
        }
        else {
            use `Season_data', clear
            merge 1:1 district_mod using `tmp'
            drop _merge
            save `Season_data', replace
        }
}
<</dd_do>>

<h5 style='text-align: left;'>Mundakan</h5>

<div>
<table border="1" style="border-collapse: collapse; width: 50%; text-align: center;">
  <thead style="background-color: #f2f2f2;">
    <tr>
      <th>District</th>
      <th>Used farmyard manure (%)</th>
      <th> Used green manure (%)</th>
      <th>Used stubble (%)</th>
      <th>Used vermi compost (%)</th>
    </tr>
  </thead>

<<dd_do:nocommands nooutput>>
use `Season_data', clear
levelsof district_mod, local(districts)
<</dd_do>>
<<dd_do:nocommands >>

foreach d of local districts {
    capture confirm variable percent1_mundak_manure_1_YN
    if !_rc {
        quietly su percent1_mundak_manure_1_YN if district_mod == `d', meanonly
        local p1 = string(r(mean), "%9.2f")
    }
    else local p1 = "NA"

    capture confirm variable percent1_mundak_manure_2_YN
    if !_rc {
        quietly su percent1_mundak_manure_2_YN if district_mod == `d', meanonly
        local p2 = string(r(mean), "%9.2f")
    }
    else local p2 = "NA"

    capture confirm variable percent1_mundak_manure_3_YN
    if !_rc {
        quietly su percent1_mundak_manure_3_YN if district_mod == `d', meanonly
        local p3 = string(r(mean), "%9.2f")
    }
    else local p3 = "NA"

    capture confirm variable percent1_mundak_manure_4_YN
    if !_rc {
        quietly su percent1_mundak_manure_4_YN if district_mod == `d', meanonly
        local p4 = string(r(mean), "%9.2f")
    }
    else local p4 = "NA"

    capture local name : label (district_mod) `d'
    if _rc != 0 local name = string(`d')

    di "<tr><td>`name'</td><td>`p1'</td><td>`p2'</td><td>`p3'</td><td>`p4'</td></tr>"
}

* Now compute totals for all districts (overall)
capture confirm variable percent1_mundak_manure_1_YN
if !_rc {
    quietly su percent1_mundak_manure_1_YN, meanonly
    local p1S = string(r(mean), "%9.2f")
}
else local p1S = "NA"

capture confirm variable percent1_mundak_manure_2_YN
if !_rc {
    quietly su percent1_mundak_manure_2_YN, meanonly
    local p2S = string(r(mean), "%9.2f")
}
else local p2S = "NA"

capture confirm variable percent1_mundak_manure_3_YN
if !_rc {
    quietly su percent1_mundak_manure_3_YN, meanonly
    local p3S = string(r(mean), "%9.2f")
}
else local p3S = "NA"

capture confirm variable percent1_mundak_manure_4_YN
if !_rc {
    quietly su percent1_mundak_manure_4_YN, meanonly
    local p4S = string(r(mean), "%9.2f")
}
else local p4S = "NA"
* Print the total row once
di "<tr><td><strong>Total</strong></td><td>`p1S'</td><td>`p2S'</td><td>`p3S'</td><td>`p4S'</td></tr>"
<</dd_do>>
</table>
</div>


<!-- Types of Organic manure (Puncha) -->
<<dd_do:nocommands nooutput >>
use "LCAS.dta"
local preplist puncha_manure_1_YN puncha_manure_2_YN puncha_manure_3_YN puncha_manure_4_YN puncha_manure_5_YN

* Temporary file to store the combined result
tempfile Season_data

*---------------------------------------------------
* 2. Loop through each organic manure variable
*---------------------------------------------------
local n : word count `preplist'
forvalues i = 1/`n' {
    
    local prepvar : word `i' of `preplist'
    
    restore
    preserve
        * Keep only cultivated cases for this season
        keep if ricecult_puncha == 1
        
        * Count applications by district
        contract district_mod `prepvar'
        
        * Compute total plots per district
        by district_mod (`prepvar'), sort: gen total = sum(_freq)
        by district_mod (`prepvar'), sort: replace total = total[_N]
        
        * Compute percentages
        gen percent = 100 * _freq / total
        replace percent = round(percent,0.01)
        drop _freq total
        
        * Reshape to wide format for this prep variable
        reshape wide percent, i(district_mod) j(`prepvar')
        
        * Drop unnecessary percent columns if exist
        capture drop percent9998
        capture drop percent2
        
        * Rename columns with prepvar suffix
        rename percent* percent*_`prepvar'
        foreach v of varlist percent*_`prepvar' {
    replace `v' = 0 if missing(`v')
}

        * Save temporary result
        tempfile tmp
        save `tmp'

        * Merge into cumulative Season_data
        capture confirm file `Season_data'
        if _rc != 0 {
            * First dataset
            use `tmp', clear
            save `Season_data', replace
        }
        else {
            use `Season_data', clear
            merge 1:1 district_mod using `tmp'
            drop _merge
            save `Season_data', replace
        }
}
<</dd_do>>

<h5 style='text-align: left;'>Puncha</h5>

<div>
<table border="1" style="border-collapse: collapse; width: 50%; text-align: center;">
  <thead style="background-color: #f2f2f2;">
    <tr>
      <th>District</th>
      <th>Used farmyard manure (%)</th>
      <th> Used green manure (%)</th>
      <th>Used stubble (%)</th>
      <th>Used vermi compost (%)</th>
    </tr>
  </thead>

<<dd_do:nocommands nooutput>>
use `Season_data', clear
levelsof district_mod, local(districts)
<</dd_do>>
<<dd_do:nocommands >>
* First print the district-wise rows

foreach d of local districts {
    capture confirm variable percent1_puncha_manure_1_YN
    if !_rc {
        quietly su percent1_puncha_manure_1_YN if district_mod == `d', meanonly
        local p1 = string(r(mean), "%9.2f")
    }
    else local p1 = "NA"

    capture confirm variable percent1_puncha_manure_2_YN
    if !_rc {
        quietly su percent1_puncha_manure_2_YN if district_mod == `d', meanonly
        local p2 = string(r(mean), "%9.2f")
    }
    else local p2 = "NA"

    capture confirm variable percent1_puncha_manure_3_YN
    if !_rc {
        quietly su percent1_puncha_manure_3_YN if district_mod == `d', meanonly
        local p3 = string(r(mean), "%9.2f")
    }
    else local p3 = "NA"

    capture confirm variable percent1_puncha_manure_4_YN
    if !_rc {
        quietly su percent1_puncha_manure_4_YN if district_mod == `d', meanonly
        local p4 = string(r(mean), "%9.2f")
    }
    else local p4 = "NA"

    capture local name : label (district_mod) `d'
    if _rc != 0 local name = string(`d')

    di "<tr><td>`name'</td><td>`p1'</td><td>`p2'</td><td>`p3'</td><td>`p4'</td></tr>"
}

* Now compute totals for all districts (overall)
capture confirm variable percent1_puncha_manure_1_YN
if !_rc {
    quietly su percent1_puncha_manure_1_YN, meanonly
    local p1S = string(r(mean), "%9.2f")
}
else local p1S = "NA"

capture confirm variable percent1_puncha_manure_2_YN
if !_rc {
    quietly su percent1_puncha_manure_2_YN, meanonly
    local p2S = string(r(mean), "%9.2f")
}
else local p2S = "NA"

capture confirm variable percent1_puncha_manure_3_YN
if !_rc {
    quietly su percent1_puncha_manure_3_YN, meanonly
    local p3S = string(r(mean), "%9.2f")
}
else local p3S = "NA"

capture confirm variable percent1_puncha_manure_4_YN
if !_rc {
    quietly su percent1_puncha_manure_4_YN, meanonly
    local p4S = string(r(mean), "%9.2f")
}
else local p4S = "NA"

* Print the total row once
di "<tr><td><strong>Total</strong></td><td>`p1S'</td><td>`p2S'</td><td>`p3S'</td><td>`p4S'</td></tr>"
<</dd_do>>
</table>
</div>


 <!-- Third table(Quantity) -->
 <div style="display: flex; flex-direction: column; gap: 20px;margin-top: 10px;">
 <div>
    <table border="1" style="border-collapse: collapse; width: 50%; text-align: center;">
      <thead style="background-color: #f2f2f2;">
     <tr>
      <th>District</th>
      <th>Virippu (kg/acre)</th>
      <th>Mundakan (kg/acre)</th>
      <th>Puncha (kg/acre)</th>
    </tr>
    </thead>

<<dd_do:nocommands nooutput>>
use "LCAS.dta", clear
levelsof district_mod, local(districts)
    qui su Virippu_OM_total_acre if ricecult_virripu==1, meanonly
    local Loc_b = string(r(mean), "%6.2f")
    
    qui su Mundak_OM_total_acre if ricecult_mundak==1, meanonly
    local Loc_c = string(r(mean), "%6.2f")
    
    qui su Puncha_OM_total_acre if ricecult_puncha==1, meanonly
    local Loc_s = string(r(mean), "%6.2f")
<</dd_do>>

<h4 style='text-align: left;'>Quantity of organic manure applied</h4>

The average quantity of organic manure applied in **Virippu** is <<dd_display:`Loc_b'>> kg/acre.The average quantity of organic manure applied in **Mundakan** is <<dd_display:`Loc_c'>> kg/acre. The average quantity of organic manure applied in **Puncha** is <<dd_display:`Loc_b'>> kg/acre.

<<dd_do:nocommands>>
foreach d of local districts {
    * Compute means for plots where cultivated = 1
    qui su Virippu_OM_total_acre if district_mod==`d' & ricecult_virripu==1, meanonly
    local Loc_V = string(r(mean), "%6.2f")
    
    qui su Mundak_OM_total_acre if district_mod==`d' & ricecult_mundak==1, meanonly
    local Loc_M = string(r(mean), "%6.2f")
    
    qui su Puncha_OM_total_acre if district_mod==`d' & ricecult_puncha==1, meanonly
    local Loc_P = string(r(mean), "%6.2f")
    
    * Get district label (fallback to numeric if unlabeled)
    capture local name : label (district_mod) `d'    
    if _rc != 0 local name = string(`d')
    
    * Display HTML table row
    di "<tr><td>`name'</td><td>`Loc_V'</td><td>`Loc_M'</td><td>`Loc_P'</td></tr>"
}
<</dd_do>>
 </table>
 </div>
 </div>

<!-- Table: Types of Fertilizer -->
<h4 style='text-align: left;'>Types of fertilizers applied</h4> 
The proportion of respondents choosing to apply each type of fertiizer in each season is as follows:

<!-- Types of Fertilizer (Virippu) -->
<<dd_do:nocommands nooutput >>
use "LCAS.dta"
local preplist virippu_nutrimng1_1_YN virippu_nutrimng1_2_YN virippu_nutrimng1_3_YN virippu_nutrimng1_4_YN virippu_nutrimng1_5_YN virippu_nutrimng1_6_YN virippu_nutrimng1_7_YN virippu_nutrimng1_8_YN 

tempfile Season_data

local n : word count `preplist'
forvalues i = 1/`n' {
    local prepvar : word `i' of `preplist'

    capture confirm variable `prepvar'
    if _rc { 
        di as txt "Skipping: `prepvar' (variable not found)"
        continue
    }
    
    restore
    preserve
        keep if ricecult_virripu == 1
        contract district_mod `prepvar'
        
        by district_mod (`prepvar'), sort: gen total = sum(_freq)
        by district_mod (`prepvar'), sort: replace total = total[_N]
        
        gen percent = 100 * _freq / total
        replace percent = round(percent,0.01)
        drop _freq total
        
        reshape wide percent, i(district_mod) j(`prepvar')
        capture drop percent9998
        capture drop percent2 

        rename percent* percent*_`prepvar'
        foreach v of varlist percent*_`prepvar' {
            replace `v' = 0 if missing(`v')
        }

        tempfile tmp
        save `tmp'

        capture confirm file `Season_data'
        if _rc != 0 {
            use `tmp', clear
            save `Season_data', replace
        }
        else {
            use `Season_data', clear
            merge 1:1 district_mod using `tmp'
            drop _merge
            save `Season_data', replace
        }
}

<</dd_do>>

<h5 style='text-align: left;'>Virippu</h5>

<div>
<table border="1" style="border-collapse: collapse; width: 50%; text-align: center;">
  <thead style="background-color: #f2f2f2;">
    <tr>
      <th>District</th>
      <th>Lime (%)</th>
      <th> Urea (%)</th>
      <th>DAP(%)</th>
      <th>MOP(%)</th>
      <th>SSP (%)</th>
      <th>Factamfos(%)</th>
      <th>Micronutrients(%)</th>
      <th>Bio-fertilizer(%)</th>
    </tr>
  </thead>

<<dd_do:nocommands nooutput>>
use `Season_data', clear
levelsof district_mod, local(districts)
<</dd_do>>
<<dd_do:nocommands >>
foreach d of local districts {
    capture confirm variable percent1_virippu_nutrimng1_1_YN 
    if !_rc {
        quietly su percent1_virippu_nutrimng1_1_YN  if district_mod == `d', meanonly
        local p1 = string(r(mean), "%9.2f")
    }
    else local p1 = "NA"

    capture confirm variable percent1_virippu_nutrimng1_2_YN 
    if !_rc {
        quietly su percent1_virippu_nutrimng1_2_YN  if district_mod == `d', meanonly
        local p2 = string(r(mean), "%9.2f")
    }
    else local p2 = "NA"

    capture confirm variable percent1_virippu_nutrimng1_3_YN 
    if !_rc {
        quietly su percent1_virippu_nutrimng1_3_YN  if district_mod == `d', meanonly
        local p3 = string(r(mean), "%9.2f")
    }
    else local p3 = "NA"

    capture confirm variable percent1_virippu_nutrimng1_4_YN 
    if !_rc {
        quietly su percent1_virippu_nutrimng1_4_YN  if district_mod == `d', meanonly
        local p4 = string(r(mean), "%9.2f")
    }
    else local p4 = "NA"

    capture confirm variable percent1_virippu_nutrimng1_5_YN 
    if !_rc {
        quietly su percent1_virippu_nutrimng1_5_YN  if district_mod == `d', meanonly
        local p5 = string(r(mean), "%9.2f")
    }
    else local p5 = "NA"

    capture confirm variable percent1_virippu_nutrimng1_6_YN 
    if !_rc {
        quietly su percent1_virippu_nutrimng1_6_YN  if district_mod == `d', meanonly
        local p6 = string(r(mean), "%9.2f")
    }
    else local p6 = "NA"

    capture confirm variable percent1_virippu_nutrimng1_7_YN 
    if !_rc {
        quietly su percent1_virippu_nutrimng1_7_YN  if district_mod == `d', meanonly
        local p7 = string(r(mean), "%9.2f")
    }
    else local p7 = "NA"

    capture confirm variable percent1_virippu_nutrimng1_8_YN 
    if !_rc {
        quietly su percent1_virippu_nutrimng1_8_YN  if district_mod == `d', meanonly
        local p8 = string(r(mean), "%9.2f")
    }
    else local p8 = "NA"

    capture local name : label (district_mod) `d'
    if _rc != 0 local name = string(`d')

    di "<tr><td>`name'</td><td>`p1'</td><td>`p2'</td><td>`p3'</td><td>`p4'</td><td>`p5'</td><td>`p6'</td><td>`p7'</td><td>`p8'</td></tr>"
}

* Now compute totals for all districts (overall)
capture confirm variable percent1_virippu_nutrimng1_1_YN
if !_rc {
    quietly su percent1_virippu_nutrimng1_1_YN, meanonly
    local p1S = string(r(mean), "%9.2f")
}
else local p1S = "NA"

capture confirm variable percent1_virippu_nutrimng1_2_YN
if !_rc {
    quietly su percent1_virippu_nutrimng1_2_YN, meanonly
    local p2S = string(r(mean), "%9.2f")
}
else local p2S = "NA"

capture confirm variable percent1_virippu_nutrimng1_3_YN
if !_rc {
    quietly su percent1_virippu_nutrimng1_3_YN, meanonly
    local p3S = string(r(mean), "%9.2f")
}
else local p3S = "NA"

capture confirm variable percent1_virippu_nutrimng1_4_YN
if !_rc {
    quietly su percent1_virippu_nutrimng1_4_YN, meanonly
    local p4S = string(r(mean), "%9.2f")
}
else local p4S = "NA"
capture confirm variable percent1_virippu_nutrimng1_5_YN
if !_rc {
    quietly su percent1_virippu_nutrimng1_5_YN, meanonly
    local p5S = string(r(mean), "%9.2f")
}
else local p5S = "NA"

capture confirm variable percent1_virippu_nutrimng1_6_YN
if !_rc {
    quietly su percent1_virippu_nutrimng1_6_YN, meanonly
    local p6S = string(r(mean), "%9.2f")
}
else local p6S = "NA"

capture confirm variable percent1_virippu_nutrimng1_7_YN
if !_rc {
    quietly su percent1_virippu_nutrimng1_7_YN, meanonly
    local p7S = string(r(mean), "%9.2f")
}
else local p7S = "NA"

capture confirm variable percent1_virippu_nutrimng1_8_YN
if !_rc {
    quietly su percent1_virippu_nutrimng1_8_YN, meanonly
    local p8S = string(r(mean), "%9.2f")
}
else local p8S = "NA"

di "<tr><td><strong>Total</strong></td><td>`p1S'</td><td>`p2S'</td><td>`p3S'</td><td>`p4S'</td><td>`p5S'</td><td>`p6S'</td><td>`p7S'</td><td>`p8S'</td></tr>"
<</dd_do>>
</table>
</div>

<!-- Types of  Fertilizer (Mundakan) -->
<<dd_do:nocommands nooutput >>
use "LCAS.dta"
local preplist mundank_nutrimng1_1_YN mundank_nutrimng1_2_YN mundank_nutrimng1_3_YN mundank_nutrimng1_4_YN mundank_nutrimng1_5_YN mundank_nutrimng1_6_YN mundank_nutrimng1_7_YN mundank_nutrimng1_8_YN

tempfile Season_data

*---------------------------------------------------
*Loop through each organic manure variable (Mundakan)
*---------------------------------------------------
local n : word count `preplist'
forvalues i = 1/`n' {
    
    local prepvar : word `i' of `preplist'
    
    restore
    preserve
        * Keep only cultivated cases for this season
        keep if ricecult_mundak == 1
        
        * Count applications by district
        contract district_mod `prepvar'
        
        * Compute total plots per district
        by district_mod (`prepvar'), sort: gen total = sum(_freq)
        by district_mod (`prepvar'), sort: replace total = total[_N]
        
        * Compute percentages
        gen percent = 100 * _freq / total
        replace percent = round(percent,0.01)
        drop _freq total
        
        * Reshape to wide format for this prep variable
        reshape wide percent, i(district_mod) j(`prepvar')
        
        * Drop unnecessary percent columns if exist
        capture drop percent9998
        capture drop percent2
        
        * Rename columns with prepvar suffix
        rename percent* percent*_`prepvar'
        foreach v of varlist percent*_`prepvar' {
    replace `v' = 0 if missing(`v')
}

        * Save temporary result
        tempfile tmp
        save `tmp'

        * Merge into cumulative Season_data
        capture confirm file `Season_data'
        if _rc != 0 {
            * First dataset
            use `tmp', clear
            save `Season_data', replace
        }
        else {
            use `Season_data', clear
            merge 1:1 district_mod using `tmp'
            drop _merge
            save `Season_data', replace
        }
}
<</dd_do>>

<h5 style='text-align: left;'>Mundakan</h5>

<div>
<table border="1" style="border-collapse: collapse; width: 50%; text-align: center;">
  <thead style="background-color: #f2f2f2;">
    <tr>
      <th>District</th>
      <th>Lime (%)</th>
      <th> Urea (%)</th>
      <th>DAP(%)</th>
      <th>MOP(%)</th>
      <th>SSP (%)</th>
      <th>Factamfos(%)</th>
      <th>Micronutrients(%)</th>
      <th>Bio-fertilizer(%)</th>
    </tr>
  </thead>

<<dd_do:nocommands nooutput>>
use `Season_data', clear
levelsof district_mod, local(districts)
<</dd_do>>
<<dd_do:nocommands >>

foreach d of local districts {
    capture confirm variable percent1_mundank_nutrimng1_1_YN
    if !_rc {
        quietly su percent1_mundank_nutrimng1_1_YN if district_mod == `d', meanonly
        local p1 = string(r(mean), "%9.2f")
    }
    else local p1 = "NA"

    capture confirm variable percent1_mundank_nutrimng1_2_YN
    if !_rc {
        quietly su percent1_mundank_nutrimng1_2_YN if district_mod == `d', meanonly
        local p2 = string(r(mean), "%9.2f")
    }
    else local p2 = "NA"

    capture confirm variable percent1_mundank_nutrimng1_3_YN
    if !_rc {
        quietly su percent1_mundank_nutrimng1_3_YN if district_mod == `d', meanonly
        local p3 = string(r(mean), "%9.2f")
    }
    else local p3 = "NA"

    capture confirm variable percent1_mundank_nutrimng1_4_YN
    if !_rc {
        quietly su percent1_mundank_nutrimng1_4_YN if district_mod == `d', meanonly
        local p4 = string(r(mean), "%9.2f")
    }
    else local p4 = "NA"

    capture confirm variable percent1_mundank_nutrimng1_5_YN
    if !_rc {
        quietly su percent1_mundank_nutrimng1_5_YN if district_mod == `d', meanonly
        local p5 = string(r(mean), "%9.2f")
    }
    else local p5 = "NA"

    capture confirm variable percent1_mundank_nutrimng1_6_YN
    if !_rc {
        quietly su percent1_mundank_nutrimng1_6_YN if district_mod == `d', meanonly
        local p6 = string(r(mean), "%9.2f")
    }
    else local p6 = "NA"

    capture confirm variable percent1_mundank_nutrimng1_7_YN
    if !_rc {
        quietly su percent1_mundank_nutrimng1_7_YN if district_mod == `d', meanonly
        local p7 = string(r(mean), "%9.2f")
    }
    else local p7 = "NA"

    capture confirm variable percent1_mundank_nutrimng1_8_YN
    if !_rc {
        quietly su percent1_mundank_nutrimng1_8_YN if district_mod == `d', meanonly
        local p8 = string(r(mean), "%9.2f")
    }
    else local p8 = "NA"

    capture local name : label (district_mod) `d'
    if _rc != 0 local name = string(`d')

    di "<tr><td>`name'</td><td>`p1'</td><td>`p2'</td><td>`p3'</td><td>`p4'</td><td>`p5'</td><td>`p6'</td><td>`p7'</td><td>`p8'</td></tr>"
}

* Now compute totals for all districts (overall)
capture confirm variable percent1_mundank_nutrimng1_1_YN
if !_rc {
    quietly su percent1_mundank_nutrimng1_1_YN, meanonly
    local p1S = string(r(mean), "%9.2f")
}
else local p1S = "NA"

capture confirm variable percent1_mundank_nutrimng1_2_YN
if !_rc {
    quietly su percent1_mundank_nutrimng1_2_YN, meanonly
    local p2S = string(r(mean), "%9.2f")
}
else local p2S = "NA"

capture confirm variable percent1_mundank_nutrimng1_3_YN
if !_rc {
    quietly su percent1_mundank_nutrimng1_3_YN, meanonly
    local p3S = string(r(mean), "%9.2f")
}
else local p3S = "NA"

capture confirm variable percent1_mundank_nutrimng1_4_YN
if !_rc {
    quietly su percent1_mundank_nutrimng1_4_YN, meanonly
    local p4S = string(r(mean), "%9.2f")
}
else local p4S = "NA"
capture confirm variable percent1_mundank_nutrimng1_5_YN
if !_rc {
    quietly su percent1_mundank_nutrimng1_5_YN, meanonly
    local p5S = string(r(mean), "%9.2f")
}
else local p5S = "NA"

capture confirm variable percent1_mundank_nutrimng1_6_YN
if !_rc {
    quietly su percent1_mundank_nutrimng1_6_YN, meanonly
    local p6S = string(r(mean), "%9.2f")
}
else local p6S = "NA"

capture confirm variable percent1_mundank_nutrimng1_7_YN
if !_rc {
    quietly su percent1_mundank_nutrimng1_7_YN, meanonly
    local p7S = string(r(mean), "%9.2f")
}
else local p7S = "NA"

capture confirm variable percent1_mundank_nutrimng1_8_YN
if !_rc {
    quietly su percent1_mundank_nutrimng1_8_YN, meanonly
    local p8S = string(r(mean), "%9.2f")
}
else local p8S = "NA"

* Print the total row once
di "<tr><td><strong>Total</strong></td><td>`p1S'</td><td>`p2S'</td><td>`p3S'</td><td>`p4S'</td><td>`p5S'</td><td>`p6S'</td><td>`p7S'</td><td>`p8S'</td></tr>"

<</dd_do>>
</table>
</div>


<!-- Types of Fertilizer (Puncha) -->
<<dd_do:nocommands nooutput >>
use "LCAS.dta"
local preplist puncha_nutrimng1_1_YN puncha_nutrimng1_2_YN puncha_nutrimng1_3_YN puncha_nutrimng1_4_YN puncha_nutrimng1_5_YN puncha_nutrimng1_6_YN puncha_nutrimng1_7_YN puncha_nutrimng1_8_YN

* Temporary file to store the combined result
tempfile Season_data

*---------------------------------------------------
* 2. Loop through each organic   n variable
*---------------------------------------------------
local n : word count `preplist'
forvalues i = 1/`n' {
    
    local prepvar : word `i' of `preplist'
    
    restore
    preserve
        * Keep only cultivated cases for this season
        keep if ricecult_puncha == 1
        
        * Count applications by district
        contract district_mod `prepvar'
        
        * Compute total plots per district
        by district_mod (`prepvar'), sort: gen total = sum(_freq)
        by district_mod (`prepvar'), sort: replace total = total[_N]
        
        * Compute percentages
        gen percent = 100 * _freq / total
        replace percent = round(percent,0.01)
        drop _freq total
        
        * Reshape to wide format for this prep variable
        reshape wide percent, i(district_mod) j(`prepvar')
        
        * Drop unnecessary percent columns if exist
        capture drop percent9998
        capture drop percent2
        
        * Rename columns with prepvar suffix
        rename percent* percent*_`prepvar'
        foreach v of varlist percent*_`prepvar' {
    replace `v' = 0 if missing(`v')
}

        * Save temporary result
        tempfile tmp
        save `tmp'

        * Merge into cumulative Season_data
        capture confirm file `Season_data'
        if _rc != 0 {
            * First dataset
            use `tmp', clear
            save `Season_data', replace
        }
        else {
            use `Season_data', clear
            merge 1:1 district_mod using `tmp'
            drop _merge
            save `Season_data', replace
        }
}
<</dd_do>>

<h5 style='text-align: left;'>Puncha</h5>

<div>
<table border="1" style="border-collapse: collapse; width: 50%; text-align: center;">
  <thead style="background-color: #f2f2f2;">
    <tr>
      <th>District</th>
      <th>Lime (%)</th>
      <th> Urea (%)</th>
      <th>DAP(%)</th>
      <th>MOP(%)</th>
      <th>SSP (%)</th>
      <th>Factamfos(%)</th>
      <th>Micronutrients(%)</th>
      <th>Bio-fertilizer(%)</th>
    </tr>
  </thead>

<<dd_do:nocommands nooutput>>
use `Season_data', clear
levelsof district_mod, local(districts)
<</dd_do>>
<<dd_do:nocommands >>
* First print the district-wise rows

foreach d of local districts {
    capture confirm variable percent1_puncha_nutrimng1_1_YN
    if !_rc {
        quietly su percent1_puncha_nutrimng1_1_YN if district_mod == `d', meanonly
        local p1 = string(r(mean), "%9.2f")
    }
    else local p1 = "NA"

    capture confirm variable percent1_puncha_nutrimng1_2_YN
    if !_rc {
        quietly su percent1_puncha_nutrimng1_2_YN if district_mod == `d', meanonly
        local p2 = string(r(mean), "%9.2f")
    }
    else local p2 = "NA"

    capture confirm variable percent1_puncha_nutrimng1_3_YN
    if !_rc {
        quietly su percent1_puncha_nutrimng1_3_YN if district_mod == `d', meanonly
        local p3 = string(r(mean), "%9.2f")
    }
    else local p3 = "NA"

    capture confirm variable percent1_puncha_nutrimng1_4_YN
    if !_rc {
        quietly su percent1_puncha_nutrimng1_4_YN if district_mod == `d', meanonly
        local p4 = string(r(mean), "%9.2f")
    }
    else local p4 = "NA"
    capture confirm variable percent1_puncha_nutrimng1_5_YN
    if !_rc {
        quietly su percent1_puncha_nutrimng1_5_YN if district_mod == `d', meanonly
        local p5 = string(r(mean), "%9.2f")
    }
    else local p5 = "NA"

    capture confirm variable percent1_puncha_nutrimng1_6_YN
    if !_rc {
        quietly su percent1_puncha_nutrimng1_6_YN if district_mod == `d', meanonly
        local p6 = string(r(mean), "%9.2f")
    }
    else local p6 = "NA"

    capture confirm variable percent1_puncha_nutrimng1_7_YN
    if !_rc {
        quietly su percent1_puncha_nutrimng1_7_YN if district_mod == `d', meanonly
        local p7 = string(r(mean), "%9.2f")
    }
    else local p7 = "NA"

    capture confirm variable percent1_puncha_nutrimng1_8_YN
    if !_rc {
        quietly su percent1_puncha_nutrimng1_8_YN if district_mod == `d', meanonly
        local p8 = string(r(mean), "%9.2f")
    }
    else local p8 = "NA"

    capture local name : label (district_mod) `d'
    if _rc != 0 local name = string(`d')

    di "<tr><td>`name'</td><td>`p1'</td><td>`p2'</td><td>`p3'</td><td>`p4'</td><td>`p5'</td><td>`p6'</td><td>`p7'</td><td>`p8'</td></tr>"
}

* Now compute totals for all districts (overall)
capture confirm variable percent1_puncha_nutrimng1_1_YN
if !_rc {
    quietly su percent1_puncha_nutrimng1_1_YN, meanonly
    local p1S = string(r(mean), "%9.2f")
}
else local p1S = "NA"

capture confirm variable percent1_puncha_nutrimng1_2_YN
if !_rc {
    quietly su percent1_puncha_nutrimng1_2_YN, meanonly
    local p2S = string(r(mean), "%9.2f")
}
else local p2S = "NA"

capture confirm variable percent1_puncha_nutrimng1_3_YN
if !_rc {
    quietly su percent1_puncha_nutrimng1_3_YN, meanonly
    local p3S = string(r(mean), "%9.2f")
}
else local p3S = "NA"

capture confirm variable percent1_puncha_nutrimng1_4_YN
if !_rc {
    quietly su percent1_puncha_nutrimng1_4_YN, meanonly
    local p4S = string(r(mean), "%9.2f")
}
else local p4S = "NA"
capture confirm variable percent1_puncha_nutrimng1_5_YN
if !_rc {
    quietly su percent1_puncha_nutrimng1_5_YN, meanonly
    local p5S = string(r(mean), "%9.2f")
}
else local p5S = "NA"

capture confirm variable percent1_puncha_nutrimng1_6_YN
if !_rc {
    quietly su percent1_puncha_nutrimng1_6_YN, meanonly
    local p6S = string(r(mean), "%9.2f")
}
else local p6S = "NA"

capture confirm variable percent1_puncha_nutrimng1_7_YN
if !_rc {
    quietly su percent1_puncha_nutrimng1_7_YN, meanonly
    local p7S = string(r(mean), "%9.2f")
}
else local p7S = "NA"

capture confirm variable percent1_puncha_nutrimng1_8_YN
if !_rc {
    quietly su percent1_puncha_nutrimng1_8_YN, meanonly
    local p8S = string(r(mean), "%9.2f")
}
else local p8S = "NA"* Print the total row once
di "<tr><td><strong>Total</strong></td><td>`p1S'</td><td>`p2S'</td><td>`p3S'</td><td>`p4S'</td><td>`p5S'</td><td>`p6S'</td><td>`p7S'</td><td>`p8S'</td></tr>"
<</dd_do>>
</table>
</div>

 
<!-- Quantity of fertilizers applied -->
 <div style="display: flex; flex-direction: column; gap: 20px;margin-top: 10px;">
 <div>
    <table border="1" style="border-collapse: collapse; width: 50%; text-align: center;">
      <thead style="background-color: #f2f2f2;">
     <tr>
      <th>District</th>
      <th>Virippu (kg/acre)</th>
      <th>Mundakan (kg/acre)</th>
      <th>Puncha (kg/acre)</th>
    </tr>
    </thead>

<<dd_do:nocommands nooutput>>
use "LCAS.dta", clear
levelsof district_mod, local(districts)
    qui su virippu_Total_N_acre if ricecult_virripu==1 & virippu_Total_N_acre <=120, meanonly
    local Loc_b = string(r(mean), "%6.2f")
    
    qui su Mundak_Total_N_acre if ricecult_mundak ==1 & Mundak_Total_N_acre <=120, meanonly
    local Loc_c = string(r(mean), "%6.2f")
    
    qui su puncha_Total_N_acre  if ricecult_puncha==1 & puncha_Total_N_acre <=120 , meanonly
    local Loc_s = string(r(mean), "%6.2f")
<</dd_do>>

<h4 style='text-align: left;'>Quantity of fertilizers applied</h4>

The average quantity of nitrogen applied in **Virippu** is <<dd_display:`Loc_b'>> kg/acre. The average quantity of nitrogen applied in **Mundakan** is <<dd_display:`Loc_c'>> kg/acre. The average quantity of nitrogen applied in **Puncha** is <<dd_display:`Loc_s'>> kg/acre.

<<dd_do:nocommands>>
foreach d of local districts {

    qui su virippu_Total_N_acre ///
        if district_mod==`d' & ricecult_virripu==1 & virippu_Total_N_acre<=120, meanonly
    local Loc_V = cond(r(N)>0, string(r(mean), "%6.2f"), "NA")

    qui su Mundak_Total_N_acre ///
        if district_mod==`d' & ricecult_mundak==1 & Mundak_Total_N_acre<=120, meanonly
    local Loc_M = cond(r(N)>0, string(r(mean), "%6.2f"), "NA")

    qui su puncha_Total_N_acre ///
        if district_mod==`d' & ricecult_puncha==1 & puncha_Total_N_acre<=120, meanonly
    local Loc_P = cond(r(N)>0, string(r(mean), "%6.2f"), "NA")

    * District label
    local name : label (district_mod) `d'

    di "<tr><td>`name'</td><td>`Loc_V'</td><td>`Loc_M'</td><td>`Loc_P'</td></tr>"
}
<</dd_do>>

 </table>
 </div>
 </div>

 <div style="display: flex; flex-direction: column; gap: 20px;margin-top: 10px;">
 <div>
    <table border="1" style="border-collapse: collapse; width: 50%; text-align: center;">
      <thead style="background-color: #f2f2f2;">
     <tr>
      <th>District</th>
      <th>Virippu (kg/acre)</th>
      <th>Mundakan (kg/acre)</th>
      <th>Puncha (kg/acre)</th>
    </tr>
    </thead>

<<dd_do:nocommands nooutput>>
use "LCAS.dta", clear
levelsof district_mod, local(districts)
    qui su virippu_Total_P_acre if ricecult_virripu==1 & virippu_Total_P_acre <=80, meanonly
    local Loc_b = string(r(mean), "%6.2f")
    
    qui su Mundak_Total_P_acre if ricecult_mundak ==1 & Mundak_Total_P_acre <=80, meanonly
    local Loc_c = string(r(mean), "%6.2f")
    
    qui su puncha_Total_P_acre  if ricecult_puncha==1 & puncha_Total_P_acre <=80 , meanonly
    local Loc_s = string(r(mean), "%6.2f")
<</dd_do>>


The average quantity of phosphorus applied in **Virippu** is <<dd_display:`Loc_b'>> kg/acre. The average quantity of phosphorus applied in **Mundakan** is <<dd_display:`Loc_c'>> kg/acre. The average quantity of phosphorus applied in **Puncha** is <<dd_display:`Loc_s'>> kg/acre.

<<dd_do:nocommands>>
foreach d of local districts {

    qui su virippu_Total_P_acre ///
        if district_mod==`d' & ricecult_virripu==1 & virippu_Total_P_acre<=80, meanonly
    local Loc_V = cond(r(N)>0, string(r(mean), "%6.2f"), "NA")

    qui su Mundak_Total_P_acre ///
        if district_mod==`d' & ricecult_mundak==1 & Mundak_Total_P_acre<=80, meanonly
    local Loc_M = cond(r(N)>0, string(r(mean), "%6.2f"), "NA")

    qui su puncha_Total_P_acre ///
        if district_mod==`d' & ricecult_puncha==1 & puncha_Total_P_acre<=80, meanonly
    local Loc_P = cond(r(N)>0, string(r(mean), "%6.2f"), "NA")

    * District label
    local name : label (district_mod) `d'

    di "<tr><td>`name'</td><td>`Loc_V'</td><td>`Loc_M'</td><td>`Loc_P'</td></tr>"
}
<</dd_do>>

 </table>
 </div>
 </div>

 <div style="display: flex; flex-direction: column; gap: 20px;margin-top: 10px;">
 <div>
    <table border="1" style="border-collapse: collapse; width: 50%; text-align: center;">
      <thead style="background-color: #f2f2f2;">
     <tr>
      <th>District</th>
      <th>Virippu (kg/acre)</th>
      <th>Mundakan (kg/acre)</th>
      <th>Puncha (kg/acre)</th>
    </tr>
    </thead>

<<dd_do:nocommands nooutput>>
use "LCAS.dta", clear
levelsof district_mod, local(districts)
    qui su virippu_Total_K_acre if ricecult_virripu==1 & virippu_Total_K_acre <=80, meanonly
    local Loc_b = string(r(mean), "%6.2f")
    
    qui su Mundak_Total_K_acre if ricecult_mundak ==1 & Mundak_Total_K_acre <=80, meanonly
    local Loc_c = string(r(mean), "%6.2f")
    
    qui su puncha_Total_K_acre  if ricecult_puncha==1 & puncha_Total_K_acre <=80 , meanonly
    local Loc_s = string(r(mean), "%6.2f")
<</dd_do>>


The average quantity of potassium (K) applied in **Virippu** is <<dd_display:`Loc_b'>> kg/acre. The average quantity of potassium (K) applied in **Mundakan** is <<dd_display:`Loc_c'>> kg/acre. The average quantity of potassium (K) applied in **Puncha** is <<dd_display:`Loc_s'>> kg/acre.

<<dd_do:nocommands>>
foreach d of local districts {

    qui su virippu_Total_K_acre ///
        if district_mod==`d' & ricecult_virripu==1 & virippu_Total_K_acre<=80, meanonly
    local Loc_V = cond(r(N)>0, string(r(mean), "%6.2f"), "NA")

    qui su Mundak_Total_K_acre ///
        if district_mod==`d' & ricecult_mundak==1 & Mundak_Total_K_acre<=80, meanonly
    local Loc_M = cond(r(N)>0, string(r(mean), "%6.2f"), "NA")

    qui su puncha_Total_K_acre ///
        if district_mod==`d' & ricecult_puncha==1 & puncha_Total_K_acre<=80, meanonly
    local Loc_P = cond(r(N)>0, string(r(mean), "%6.2f"), "NA")

    * District label
    local name : label (district_mod) `d'

    di "<tr><td>`name'</td><td>`Loc_V'</td><td>`Loc_M'</td><td>`Loc_P'</td></tr>"
}
<</dd_do>>

 </table>
 </div>
 </div>
</div>


<!-- Pesticide and Weedicide Application -->
<div id="pest" class="sub-tab-content">
<h4 style='text-align: left;'<strong>Pestide and Weedicide Application</strong></h4

The proportion of respondents choosing to follow pesticide and weedicide application in each season is as follows:

<<dd_do:nocommands nooutput >>
use "LCAS.dta", clear

*---------------------------------------------------
* 1. Define pesticide  application and cultivation pairs
*---------------------------------------------------
local preplist virippu_pestiappl mundank_pestiappl puncha_pestiappl 
local cultlist ricecult_virripu ricecult_mundak ricecult_puncha

* Temporary file to store the combined result
tempfile Season_data

*---------------------------------------------------
* 2. Loop through each seed treatment variable
*---------------------------------------------------
local n : word count `preplist'
forvalues i = 1/`n' {
    
    local prepvar : word `i' of `preplist'
    local cultvar : word `i' of `cultlist'
    restore
    preserve
        * Keep only cultivated cases for this season
        keep if `cultvar' == 1
        
        * Count applications by district
        contract district_mod `prepvar'
        
        * Compute total plots per district
        by district_mod (`prepvar'), sort: gen total = sum(_freq)
        by district_mod (`prepvar'), sort: replace total = total[_N]
        
        * Compute percentages
        gen percent = 100 * _freq / total
        replace percent = round(percent,0.01)
        drop _freq total
        
        * Reshape to wide format for this prep variable
        reshape wide percent, i(district_mod) j(`prepvar')
        
        * Drop unnecessary percent columns if exist
        capture drop percent9998
        capture drop percent2
        
        * Rename columns with prepvar suffix
        rename percent* percent*_`prepvar'
        foreach v of varlist percent*_`prepvar' {
    replace `v' = 0 if missing(`v')
}

        * Save temporary result
        tempfile tmp
        save `tmp'

        * Merge into cumulative Season_data
        capture confirm file `Season_data'
        if _rc != 0 {
            * First dataset
            use `tmp', clear
            save `Season_data', replace
        }
        else {
            use `Season_data', clear
            merge 1:1 district_mod using `tmp'
            drop _merge
            save `Season_data', replace
        }
}
<</dd_do>>

<div>
<table border="1" style="border-collapse: collapse; width: 50%; text-align: center;">
  <thead style="background-color: #f2f2f2;">
    <tr>
      <th>District</th>
      <th>Virippu (%)</th>
      <th>Mundakan (%)</th>
      <th>Puncha (%)</th>
    </tr>
  </thead>

<<dd_do:nocommands nooutput>>
use `Season_data', clear
levelsof district_mod, local(districts)
<</dd_do>>
<<dd_do:nocommands >>
foreach d of local districts {
    quietly su percent1_virippu_pestiappl if district_mod == `d', meanonly
    local p1 = string(r(mean), "%9.2f")
    quietly su percent1_mundank_pestiappl if district_mod == `d', meanonly
    local p2 = string(r(mean), "%9.2f")
    quietly su percent1_puncha_pestiappl if district_mod == `d', meanonly
    local p3 = string(r(mean), "%9.2f")
    capture local name : label (district_mod) `d'
    if _rc != 0 local name = string(`d')
    di "<tr><td>`name'</td><td>`p1'</td><td>`p2'</td><td>`p3'</td></tr>" 
}
<</dd_do>>
</table>
</div>

<<dd_do:nocommands nooutput >>
use "LCAS.dta", clear

*---------------------------------------------------
* 1. Define weedicide  application and cultivation pairs
*---------------------------------------------------
local preplist virippu_weed4 mundank_weed4 puncha_weed4
local cultlist ricecult_virripu ricecult_mundak ricecult_puncha

* Temporary file to store the combined result
tempfile Season_data

*---------------------------------------------------
* 2. Loop through each weedicide application variable
*---------------------------------------------------
local n : word count `preplist'
forvalues i = 1/`n' {
    
    local prepvar : word `i' of `preplist'
    local cultvar : word `i' of `cultlist'
    restore
    preserve
        * Keep only cultivated cases for this season
        keep if `cultvar' == 1
        
        * Count applications by district
        contract district_mod `prepvar'
        
        * Compute total plots per district
        by district_mod (`prepvar'), sort: gen total = sum(_freq)
        by district_mod (`prepvar'), sort: replace total = total[_N]
        
        * Compute percentages
        gen percent = 100 * _freq / total
        replace percent = round(percent,0.01)
        drop _freq total
        
        * Reshape to wide format for this prep variable
        reshape wide percent, i(district_mod) j(`prepvar')
        
        * Drop unnecessary percent columns if exist
        capture drop percent9998
        capture drop percent2
        
        * Rename columns with prepvar suffix
        rename percent* percent*_`prepvar'
        foreach v of varlist percent*_`prepvar' {
    replace `v' = 0 if missing(`v')
}
        * Save temporary result
        tempfile tmp
        save `tmp'

        * Merge into cumulative Season_data
        capture confirm file `Season_data'
        if _rc != 0 {
            * First dataset
            use `tmp', clear
            save `Season_data', replace
        }
        else {
            use `Season_data', clear
            merge 1:1 district_mod using `tmp'
            drop _merge
            save `Season_data', replace
        }
}
<</dd_do>>

<div>
<table border="1" style="border-collapse: collapse; width: 50%; text-align: center;">
  <thead style="background-color: #f2f2f2;">
    <tr>
      <th>District</th>
      <th>Virippu (%)</th>
      <th>Mundakan (%)</th>
      <th>Puncha (%)</th>
    </tr>
  </thead>

<<dd_do:nocommands nooutput>>
use `Season_data', clear
levelsof district_mod, local(districts)
<</dd_do>>
<<dd_do:nocommands >>
foreach d of local districts {
    quietly su percent1_virippu_weed4 if district_mod == `d', meanonly
    local p1 = string(r(mean), "%9.2f")
    quietly su percent1_mundank_weed4 if district_mod == `d', meanonly
    local p2 = string(r(mean), "%9.2f")
    quietly su percent1_puncha_weed4 if district_mod == `d', meanonly
    local p3 = string(r(mean), "%9.2f")
    capture local name : label (district_mod) `d'
    if _rc != 0 local name = string(`d')
    di "<tr><td>`name'</td><td>`p1'</td><td>`p2'</td><td>`p3'</td></tr>" 
}
<</dd_do>>
</table>
</div>
</div>


<div id="water" class="sub-tab-content">
<h4 style='text-align: left;'<strong>Water availability and drainage scenario in the paddyland operated</strong></h4

The water availability and drainage scenario,as per the respondents, in the paddy parcels based on their proximity to head/middle/tail end of tertiary/secondary canals is as follows:

<<dd_do:nocommands nooutput >>
local watervars fieldcnl_wateravail_1 fieldcnl_wateravail_2 fieldcnl_wateravail_3
local graphnames Wateravail_headend Wateravail_middleend Wateravail_tailend
local endnames Headend Middleend Tailend
local nvars : word count `watervars'

forval i = 1/`nvars' {
    local var : word `i' of `watervars'
    local gname : word `i' of `graphnames'
    local ename : word `i' of `endnames'
    restore
    preserve
    contract `var' district_mod
    rename _freq count
    bysort district_mod (`var'): gen total = sum(count)
    bysort district_mod (`var'): replace total = total[_N-1]
    gen percent = (count / total) * 100
    drop if `var' == 9998

    graph bar percent , over(`var', label(angle(vertical))) by(district_mod, title("{bf:Water availability in paddy polders:`ename'}", size(medlarge) span))bar(1, color(navy%40)) blabel(bar, format(%5.1f)) scheme(white_brbg) subtitle(, color(yellow) fcolor(black)) plotregion(ilcolor(black) ilpattern(vshortdash))

    graph save `gname'.gph, replace
}


graph combine Wateravail_headend.gph Wateravail_middleend.gph Wateravail_tailend.gph,xsize(9) ysize(13) cols(1)
graph export Wateravail_combined.png, replace 

local watervars fieldcnl_drinage_1_mod fieldcnl_drinage_2_mod fieldcnl_drinage_3_mod
local graphnames Drainage_headend Drainage_middleend Drainage_tailend
local endnames Headend Middleend Tailend
local nvars : word count `watervars'

forval i = 1/`nvars' {
    local var : word `i' of `watervars'
    local gname : word `i' of `graphnames'
    local ename : word `i' of `endnames'
    restore
    preserve
    contract `var' district_mod
    rename _freq count
    bysort district_mod (`var'): gen total = sum(count)
    bysort district_mod (`var'): replace total = total[_N-1]
    gen percent = (count / total) * 100
    drop if `var' == 9998

    graph bar percent if `var' != .,over(`var', label(angle(vertical)))by(district_mod, title("{bf:Drainage availability in paddy polders:`ename'}", size(medlarge) span)) bar(1, color(red%40)) blabel(bar, format(%5.1f)) scheme(white_brbg)subtitle(, color(yellow) fcolor(black))plotregion(ilcolor(black) ilpattern(vshortdash))
    graph save `gname'.gph, replace
}
restore
graph combine Drainage_headend.gph Drainage_middleend.gph Drainage_tailend.gph, xsize(9) ysize(13) cols(1)
graph export Drainage_combined.png, replace

<</dd_do>>

 <!-- Image container -->
 <div style="display: flex; justify-content: center; gap: 20px; margin: 20px 0;">
  <div>
    <img src="Wateravail_combined.png" alt="Water availability scenario by district" width="500">
  </div>
  <div>
    <img src="Drainage_combined.png" alt="Drainage scenario by district" width="500">
  </div>
 </div>

<!--Water maintenance in the field-->
<h4 style='text-align: left;'>Water maintenance in the field</h4> 
Water maintenance in the field by the respondents in each season is as follows:
<<dd_do:nocommands nooutput >>
use "LCAS.dta", clear
*---------------------------------------------------
* 1. Define water maintenance and cultivation pairs
*---------------------------------------------------
local preplist  virippu_watermaint mundank_watermaint puncha_watermaint
local cultlist ricecult_virripu ricecult_mundak ricecult_puncha

* Temporary file to store the combined result
tempfile Season_data

*---------------------------------------------------
* 2. Loop through each watermaint variable
*---------------------------------------------------
local n : word count `preplist'
forvalues i = 1/`n' {
    
    local prepvar : word `i' of `preplist'
    local cultvar : word `i' of `cultlist'
    preserve
        * Keep only cultivated cases for this season
        keep if `cultvar' == 1
        
        contract district_mod `prepvar'
        by district_mod (`prepvar'), sort: gen total = sum(_freq)
        by district_mod (`prepvar'), sort: replace total = total[_N]
        gen percent = 100 * _freq / total
        replace percent = round(percent,0.01)
        drop _freq total
        reshape wide percent, i(district_mod) j(`prepvar')
        capture confirm var percent9998
        if _rc == 0 {
        drop percent9998
         }
        rename percent* percent*_`prepvar'

        * Save temporary result
        tempfile tmp
        save `tmp'

    * Merge into cumulative Season_data
    capture confirm file `Season_data'
    if _rc != 0 {
        * First dataset
        use `tmp', clear
        save `Season_data', replace
    }
    else {
        use `Season_data', clear
        merge 1:1 district_mod using `tmp'
        drop _merge
        save `Season_data', replace
    }
  restore
}

*---------------------------------------------------
*Final dataset after loop (Virippu)
*---------------------------------------------------
use `Season_data', clear

* Prepare HTML output file
tempfile htmlout
file open outfile using `htmlout', write replace
file write outfile "<table border='1' style='border-collapse: collapse; width: 80%; font-size:90%; text-align: center;'>" _n
file write outfile "<h5 style='text-align: left;'>Virippu</h5>" _n
file write outfile "<tr style='background-color:#f2f2f2;'><th>District</th><th>Always flooded(Except before harvest)(%)</th><th> Mostly flooded(Except before harvest) (%)</th><th>Sometime flooded,sometimes dry(%)</th><th>Mostly dry(%)</th></tr>" _n
levelsof district_mod, local(districts)
foreach d of local districts {
    local name : label (district_mod) `d'
    local row "<tr><td>`name'</td>"
        unab vars : percent*_virippu_watermaint
        foreach v of local vars {
            quietly su `v' if district_mod == `d', meanonly
            local meanval = cond(r(N)>0, string(r(mean), "%6.2f"), "0.00")
            local row "`row'<td>`meanval'</td>"
  }
     file write outfile "`row'</tr>" _n
 }
<</dd_do>>
<<dd_do:nocommands>>
file write outfile "</table>" _n
file close outfile
type `htmlout'
<</dd_do>>
<<dd_do:nocommands nooutput >>
*---------------------------------------------------
* Final dataset after loop (Mundakan)
*---------------------------------------------------
use `Season_data', clear

* Prepare HTML output file
tempfile htmlout
file open outfile using `htmlout', write replace
file write outfile "<table border='1' style='border-collapse: collapse; width: 80%; font-size:90%; text-align: center;'>" _n
file write outfile "<h5 style='text-align: left;'>Mundakan</h5>" _n
file write outfile "<tr style='background-color:#f2f2f2;'><th>District</th><th>Always flooded(Except before harvest)(%)</th><th>Mostly flooded(Except before harvest) (%)</th><th>Sometime flooded,sometimes dry(%)</th><th>Mostly dry(%)</th></tr>" _n
levelsof district_mod, local(districts)
foreach d of local districts {
    local name : label (district_mod) `d'
    local row "<tr><td>`name'</td>"
        unab vars : percent*_mundank_watermaint
        foreach v of local vars {
            quietly su `v' if district_mod == `d', meanonly
            local meanval = cond(r(N)>0, string(r(mean), "%6.2f"), "0.00")
            local row "`row'<td>`meanval'</td>"
 }
       file write outfile "`row'</tr>" _n
}
<</dd_do>>
<<dd_do:nocommands>>
file write outfile "</table>" _n
file close outfile
type `htmlout'
<</dd_do>>

<<dd_do:nocommands nooutput >>
*---------------------------------------------------
* Final dataset after loop (Puncha)
*---------------------------------------------------
use `Season_data', clear

* Prepare HTML output file
tempfile htmlout
file open outfile using `htmlout', write replace
file write outfile "<table border='1' style='border-collapse: collapse; width: 80%; font-size:90%; text-align: center;'>" _n
file write outfile "<h5 style='text-align: left;'>Puncha</h5>" _n
file write outfile "<tr style='background-color:#f2f2f2;'><th>District</th><th>Always flooded(Except before harvest)(%)</th><th> Mostly flooded(Except before harvest) (%)</th><th>Sometime flooded,sometimes dry(%)</th><th>Mostly dry(%)</th></tr>" _n
levelsof district_mod, local(districts)
foreach d of local districts {
    local name : label (district_mod) `d'
    local row "<tr><td>`name'</td>"
        unab vars : percent*_puncha_watermaint
        foreach v of local vars {
            quietly su `v' if district_mod == `d', meanonly
            local meanval = cond(r(N)>0, string(r(mean), "%6.2f"), "0.00")
            local row "`row'<td>`meanval'</td>"
  }
     file write outfile "`row'</tr>" _n
}
<</dd_do>>
<<dd_do:nocommands>>
file write outfile "</table>" _n
file close outfile
type `htmlout'
<</dd_do>>
</div>

<div id="yield" class="sub-tab-content">
<!-- Yield (tones/ha)-->
<h4 style="text-align: left;"><strong>Yield (tones/ha)</strong></h4>
 <<dd_do:nocommands nooutput >>
       use "LCAS.dta", clear
       sum virippu_riceproduction_acre if ricecult_virripu==1 & virippu_riceproduction_acre<=35 ,detail
       local V_mean = string(r(mean)/10, "%9.2f")
       local V_sd = string(r(sd)/10, "%9.2f")
       sum Mundak_riceproduction_acre if ricecult_mundak & Mundak_riceproduction_acre<=35 ,detail
       local M_mean = string(r(mean)/10, "%9.2f")
       local M_sd = string(r(sd)/10, "%9.2f")
       sum puncha_riceproduction_acre if ricecult_puncha==1 & puncha_riceproduction_acre <=35,detail
       local P_mean = string(r(mean)/10, "%9.2f")
       local P_sd = string(r(sd)/10, "%9.2f")
       <</dd_do>>

<h5 style='text-align: left;'>Virippu</h5>

<p>The average yield of the largest paddy parcel cultivated in <b>Virippu</b> is <<dd_display:`V_mean'>> tonnes/acre, with a standard deviation of <<dd_display:`V_sd'>> tonnes/acre.The distribution is as follows:</p>

<!-- Graph of distribution (Virippu) -->
<<dd_do:nocommands nooutput >>
use "LCAS.dta", clear
gen virippu_riceprod_acre_tonnes = virippu_riceproduction_acre/10
local colors "navy%40 red%30"
local titles "Palakkad Thrissur"
local i = 1
foreach d of numlist 1/2 {
    * Pick color and title from the list
    local color : word `i' of `colors'
    local title : word `i' of `titles'
    spikeplot virippu_riceproduction_acre if district_mod ==`d' & ricecult_virripu==1 & virippu_riceproduction_acre<=35, fraction color(`color') lpattern(solid) title(`"{bf:`title'}"' ) lwidth(vthick) scheme(white_brbg) ytitle(Fraction) xtitle(Yield(tonnes/acre)) plotregion(ilcolor(black) ilpattern(vshortdash))   
    graph save yield_V_`d'.gph, replace
    local i = `i' + 1
}
graph combine yield_V_1.gph, cols(2)
graph export "yield_V.png", replace width(2000)
<</dd_do>>

<div style="text-align:center;">
   <img src="yield_V.png" alt="Distribution of yield in Virippu by district" width="500">
</div>

<!-- Graph of distribution (Mundakan) -->
<h5 style='text-align: left;'>Mundakan</h5>
<p>The average yield of the largest paddy parcel cultivated in <b>Mundakan</b> is <<dd_display:`M_mean'>> tonnes/acre, with a standard deviation of <<dd_display:`M_sd'>> tonnes/acre. The distribution is as follows:</p>

<<dd_do:nocommands nooutput >>
gen Mundak_riceprod_acre_tonnes = Mundak_riceproduction_acre/10
local colors "green%40 maroon%30"
local titles "Palakkad Thrissur"
local i = 1        
foreach d of numlist 1/2 {
    local color : word `i' of `colors'
    local title : word `i' of `titles'
    spikeplot Mundak_riceproduction_acre if district_mod == `d' & ricecult_mundak & Mundak_riceproduction_acre<=35 , fraction color(`color') lpattern(solid) title(`"{bf:`title'}"' ) lwidth(vthick) scheme(white_brbg) ytitle(Fraction) xtitle(Yield(tonnes/acre)) plotregion(ilcolor(black) ilpattern(vshortdash))   
    graph save yield_M_`d'.gph, replace
    local i = `i' + 1
}
graph combine yield_M_1.gph yield_M_2.gph, cols(2)
graph export "yield_M.png", replace width(2000)
<</dd_do>>

<div style="text-align:center;">
   <img src="yield_M.png" alt="Distribution of yield in Mundakan by district" width="500">
</div>

<!-- Graph of distribution (Puncha) -->
<h5 style='text-align: left;'>Puncha</h5>
<p>The average yield of the largest paddy parcel cultivated in <b>Puncha</b> is <<dd_display:`P_mean'>> tonnes/acre, with a standard deviation of <<dd_display:`P_sd'>> tonnes/acre.The distribution is as follows:</p>

<<dd_do:nocommands nooutput >>
gen puncha_riceprod_acre_tonnes = puncha_riceproduction_acre/10
local colors "orange%40 purple%30"
local titles "Palakkad Thrissur"
local i = 1  
foreach d of numlist 1/2 {
    local color : word `i' of `colors'
    local title : word `i' of `titles'
    spikeplot puncha_riceproduction_acre if district_mod == `d' & ricecult_puncha==1 & puncha_riceproduction_acre <=35 , fraction color(`color') lpattern(solid) title(`"{bf:`title'}"' ) lwidth(vthick) scheme(white_brbg) ytitle(Fraction) xtitle(Yield(tonnes/acre)) plotregion(ilcolor(black) ilpattern(vshortdash))   
    graph save yield_P_`d'.gph, replace
    local i = `i' + 1
}
graph combine yield_P_1.gph yield_P_2.gph, cols(2)
graph export "yield_P.png", replace width(2000)
<</dd_do>>

<div style="text-align:center;">
   <img src="yield_P.png" alt="Distribution of yield in Puncha district" width="500">
</div>

<!-- Table container -->
<div style="display: flex; flex-direction: column; gap: 20px;">
<div>
<table border="1" style="border-collapse: collapse; width: 100%; text-align: center;">
  <thead style="background-color: #f2f2f2;">
    <tr>
      <th>District</th>
      <th>Virippu (tonnes/acre)</th>
      <th>Mundakan (tonnes/acre)</th>
      <th>Puncha (tonnes/acre)</th>
    </tr>
  </thead>

  <<dd_do:nocommands nooutput >>

    use "LCAS.dta", clear
    collapse (mean) Virippu_yield = virippu_riceproduction_acre if ricecult_virripu==1 & virippu_riceproduction_acre<=35, by(district_mod)
    tempfile virippu
    save `virippu'
    use "LCAS.dta", clear
    collapse (mean) mundakan_yield = Mundak_riceproduction_acre if  ricecult_mundak & Mundak_riceproduction_acre<=35, by(district_mod)
    tempfile mundak
    save `mundak'
    use "LCAS.dta", clear
    collapse (mean) puncha_yield = puncha_riceproduction_acre if ricecult_puncha==1 & puncha_riceproduction_acre <=35, by(district_mod)
    tempfile puncha
    save `puncha'
    use `virippu', clear
    merge 1:1 district_mod using `mundak'
    drop _merge
    merge 1:1 district_mod using `puncha'
    drop _merge
    levelsof district_mod, local(districts)
     <</dd_do>>
    <<dd_do:nocommands >>
    foreach d of local districts {
        local name : label (district_mod) `d'

        quietly su Virippu_yield if district_mod==`d', meanonly
        local V = cond(r(N)>0, string(r(mean)/10, "%6.2f"), "0.00")

        quietly su mundakan_yield if district_mod==`d', meanonly
        local M = cond(r(N)>0, string(r(mean)/10, "%6.2f"), "0.00")

        quietly su puncha_yield if district_mod==`d', meanonly
        local P = cond(r(N)>0, string(r(mean)/10, "%6.2f"), "0.00")

        di "<tr><td>`name'</td><td>`V'</td><td>`M'</td><td>`P'</td></tr>"
    }
  <</dd_do>>
</table>
</div>
</div>
<h4 style='text-align: left;'>Harvesting method</h4> 

The choice of harvesting method by the respondents in each season is as follows:

<<dd_do:nocommands nooutput >>
use "LCAS.dta", clear
*---------------------------------------------------
* 1. Define harvesting and cultivation pairs
*---------------------------------------------------
local estlist  virippu_Harvesttype Mundakan_Harvesttype Puncha_Harvesttype
local cultlist ricecult_virripu ricecult_mundak ricecult_puncha

* Temporary file to store the combined result
tempfile Season_data

*---------------------------------------------------
* 2. Loop through each harvesting variable
*---------------------------------------------------
local n : word count `estlist'
forvalues i = 1/`n' {
    
    local estvar : word `i' of `estlist'
    local cultvar : word `i' of `cultlist'
   
    preserve
    keep if `cultvar' == 1

    * Step 1: Temporarily code missing
    gen __harvest = `estvar'
    replace __harvest = 9998 if missing(__harvest)

    contract district_mod __harvest

    by district_mod (__harvest), sort: gen total = sum(_freq)
    by district_mod (__harvest), sort: replace total = total[_N]

    gen percent = 100 * _freq / total
    replace percent = round(percent,0.01)

    drop _freq total

    reshape wide percent, i(district_mod) j(__harvest)

    * Step 2: Drop missing column & no harvest from table output
    capture confirm var percent9998 percent4
    if _rc == 0 drop percent9998 percent4

    rename percent* percent*_`estvar'


        * Save temporary result
        tempfile tmp
        save `tmp'

    * Merge into cumulative Season_data
    capture confirm file `Season_data'
    if _rc != 0 {
        * First dataset
        use `tmp', clear
        save `Season_data', replace
    }
    else {
        use `Season_data', clear
        merge 1:1 district_mod using `tmp'
        drop _merge
        save `Season_data', replace
    }
 restore
}

*---------------------------------------------------
*Final dataset after loop (Virippu)
*---------------------------------------------------
use `Season_data', clear

* Prepare HTML output file
tempfile htmlout
file open outfile using `htmlout', write replace
file write outfile "<table border='1' style='border-collapse: collapse; width: 75%; font-size:100%; text-align: center;'>" _n
file write outfile "<h5 style='text-align: left;'>Virippu</h5>" _n
file write outfile "<tr style='background-color:#f2f2f2;'><th>District</th><th>Combine harvester (%)</th><th> Reaper (%)</th></tr>" _n

levelsof district_mod, local(districts)
foreach d of local districts {
    local name : label (district_mod) `d'
    local row "<tr><td>`name'</td>"
        unab vars : percent*_virippu_Harvesttype
        foreach v of local vars {
            quietly su `v' if district_mod == `d', meanonly
            local meanval = cond(r(N)>0, string(r(mean), "%6.2f"), "0.00")
            local row "`row'<td>`meanval'</td>"
  }
     file write outfile "`row'</tr>" _n
 }
<</dd_do>>
<<dd_do:nocommands>>
file write outfile "</table>" _n
file close outfile
type `htmlout'
<</dd_do>>

<<dd_do:nocommands nooutput >>
*---------------------------------------------------
* Final dataset after loop (Mundakan)
*---------------------------------------------------
use `Season_data', clear

* Prepare HTML output file
tempfile htmlout
file open outfile using `htmlout', write replace
file write outfile "<table border='1' style='border-collapse: collapse; width: 75%; font-size:100%; text-align: center;'>" _n
file write outfile "<h5 style='text-align: left;'>Mundakan</h5>" _n
file write outfile "<tr style='background-color:#f2f2f2;'><th>District</th><th>Combine harvester (%)</th><th>Reaper (%)</th><th>Manual harvest (%)</th></tr>" _n

levelsof district_mod, local(districts)
foreach d of local districts {
    local name : label (district_mod) `d'
    local row "<tr><td>`name'</td>"
        unab vars : percent*_Mundakan_Harvesttype
        foreach v of local vars {
            quietly su `v' if district_mod == `d', meanonly
            local meanval = cond(r(N)>0, string(r(mean), "%6.2f"), "0.00")
            local row "`row'<td>`meanval'</td>"
 }
       file write outfile "`row'</tr>" _n
}
<</dd_do>>
<<dd_do:nocommands>>
file write outfile "</table>" _n
file close outfile
type `htmlout'
<</dd_do>>

<<dd_do:nocommands nooutput >>
*---------------------------------------------------
* Final dataset after loop (Puncha)
*---------------------------------------------------
use `Season_data', clear

* Prepare HTML output file
tempfile htmlout
file open outfile using `htmlout', write replace
file write outfile "<table border='1' style='border-collapse: collapse; width: 75%; font-size:100%; text-align: center;'>" _n
file write outfile "<h5 style='text-align: left;'>Puncha</h5>" _n
file write outfile "<tr style='background-color:#f2f2f2;'><th>District</th><th>Combine harvester (%)</th></tr>" _n

levelsof district_mod, local(districts)
foreach d of local districts {
    local name : label (district_mod) `d'
    local row "<tr><td>`name'</td>"
        unab vars : percent*_Puncha_Harvesttype
        foreach v of local vars {
            quietly su `v' if district_mod == `d', meanonly
            local meanval = cond(r(N)>0, string(r(mean), "%6.2f"), "0.00")
            local row "`row'<td>`meanval'</td>"
  }
     file write outfile "`row'</tr>" _n
}
<</dd_do>>
<<dd_do:nocommands>>
file write outfile "</table>" _n
file close outfile
type `htmlout'
<</dd_do>>
Note: Missing percentages represent missing observations and cases of no harvest

</div>
</div>

<!-- SUBSECTION  :Residue management -->
<div id="residue" class="tab-content">
<h4 style='text-align: left;'>Ways of Straw management</h4> 
The proportion of respondents choosing to do straw/stubble management in the mentioned ways in each season is as follows:

<!-- Ways of straw management (Virippu) -->
<<dd_do:nocommands nooutput >>
use "LCAS.dta"
local preplist virippu_posthavr2_1 virippu_posthavr2_2 virippu_posthavr2_3 virippu_posthavr2_4 virippu_posthavr2_5 virippu_posthavr2_6 virippu_posthavr2_7

tempfile Season_data

local n : word count `preplist'
forvalues i = 1/`n' {
    local prepvar : word `i' of `preplist'

    capture confirm variable `prepvar'
    if _rc { 
        di as txt "Skipping: `prepvar' (variable not found)"
        continue
    }
    preserve
        keep if ricecult_virripu == 1
        contract district_mod `prepvar'
        
        by district_mod (`prepvar'), sort: gen total = sum(_freq)
        by district_mod (`prepvar'), sort: replace total = total[_N]
        
        gen percent = 100 * _freq / total
        replace percent = round(percent,0.01)
        drop _freq total
        
        reshape wide percent, i(district_mod) j(`prepvar')
        capture drop percent9998
        capture drop percent7
        
        rename percent* percent*_`prepvar'
        foreach v of varlist percent*_`prepvar' {
            replace `v' = 0 if missing(`v')
        }

        tempfile tmp
        save `tmp'

        capture confirm file `Season_data'
        if _rc != 0 {
            use `tmp', clear
            save `Season_data', replace
        }
        else {
            use `Season_data', clear
            merge 1:1 district_mod using `tmp'
            drop _merge
            save `Season_data', replace
        }
   restore
}

<</dd_do>>

<h5 style='text-align: left;'>Virippu</h5>

<div>
<table border="1" style="border-collapse: collapse; width: 50%; text-align: center;">
  <thead style="background-color: #f2f2f2;">
    <tr>
      <th>District</th>
      <th>Use for mulching (%)</th>
      <th> Mix with soil for manuring (%)</th>
      <th>Use/sell it for bioenergy/biogas/biochar production (%)</th>
      <th>Sell it for other purposes like fodder, etc(%)</th>
      <th>Use as dry fodder for own cattle (%)</th>
      <th>Burn it(%)</th>
    </tr>
  </thead>

<<dd_do:nocommands nooutput>>
use `Season_data', clear
levelsof district_mod, local(districts)
<</dd_do>>
<<dd_do:nocommands >>
foreach d of local districts {
    capture confirm variable percent1_virippu_posthavr2_1
    if !_rc {
        quietly su percent1_virippu_posthavr2_1 if district_mod == `d', meanonly
        local p1 = string(r(mean), "%9.2f")
    }
    else local p1 = "NA"

    capture confirm variable percent1_virippu_posthavr2_2
    if !_rc {
        quietly su percent1_virippu_posthavr2_2 if district_mod == `d', meanonly
        local p2 = string(r(mean), "%9.2f")
    }
    else local p2 = "NA"

    capture confirm variable percent1_virippu_posthavr2_3
    if !_rc {
        quietly su percent1_virippu_posthavr2_3 if district_mod == `d', meanonly
        local p3 = string(r(mean), "%9.2f")
    }
    else local p3 = "NA"

    capture confirm variable percent1_virippu_posthavr2_4
    if !_rc {
        quietly su percent1_virippu_posthavr2_4 if district_mod == `d', meanonly
        local p4 = string(r(mean), "%9.2f")
    }
    else local p4 = "NA"

    capture confirm variable percent1_virippu_posthavr2_5
    if !_rc {
        quietly su percent1_virippu_posthavr2_5 if district_mod == `d', meanonly
        local p5 = string(r(mean), "%9.2f")
    }
    else local p5 = "NA"

    capture confirm variable percent1_virippu_posthavr2_6
    if !_rc {
        quietly su percent1_virippu_posthavr2_6 if district_mod == `d', meanonly
        local p6 = string(r(mean), "%9.2f")
    }
    else local p6 = "NA"


    capture local name : label (district_mod) `d'
    if _rc != 0 local name = string(`d')

    di "<tr><td>`name'</td><td>`p1'</td><td>`p2'</td><td>`p3'</td><td>`p4'</td><td>`p5'</td><td>`p6'</td></tr>"
}

* Now compute totals for all districts (overall)
capture confirm variable percent1_virippu_posthavr2_1
if !_rc {
    quietly su percent1_virippu_posthavr2_1, meanonly
    local p1S = string(r(mean), "%9.2f")
}
else local p1S = "NA"

capture confirm variable percent1_virippu_posthavr2_2
if !_rc {
    quietly su percent1_virippu_posthavr2_2, meanonly
    local p2S = string(r(mean), "%9.2f")
}
else local p2S = "NA"

capture confirm variable percent1_virippu_posthavr2_3
if !_rc {
    quietly su percent1_virippu_posthavr2_3, meanonly
    local p3S = string(r(mean), "%9.2f")
}
else local p3S = "NA"

capture confirm variable percent1_virippu_posthavr2_4
if !_rc {
    quietly su percent1_virippu_posthavr2_4, meanonly
    local p4S = string(r(mean), "%9.2f")
}
else local p4S = "NA"

capture confirm variable percent1_virippu_posthavr2_5
if !_rc {
    quietly su percent1_virippu_posthavr2_5, meanonly
    local p5S = string(r(mean), "%9.2f")
}
else local p5S = "NA"

capture confirm variable percent1_virippu_posthavr2_6
if !_rc {
    quietly su percent1_virippu_posthavr2_6, meanonly
    local p6S = string(r(mean), "%9.2f")
}
else local p6S = "NA"


di "<tr><td><strong>Total</strong></td><td>`p1S'</td><td>`p2S'</td><td>`p3S'</td><td>`p4S'</td><td>`p5S'</td><td>`p6S'</td></tr>"
<</dd_do>>
</table>
</div>

<!-- Ways of straw management (Mundakan) -->
<<dd_do:nocommands nooutput >>
use "LCAS.dta"
local preplist mundank_posthavr2_1 mundank_posthavr2_1 mundank_posthavr2_2 mundank_posthavr2_3 mundank_posthavr2_4 mundank_posthavr2_5 mundank_posthavr2_6 mundank_posthavr2_7

tempfile Season_data

*---------------------------------------------------
*Loop through each organic manure variable (Mundakan)
*---------------------------------------------------
local n : word count `preplist'
forvalues i = 1/`n' {
    
    local prepvar : word `i' of `preplist'
    

    preserve
        * Keep only cultivated cases for this season
        keep if ricecult_mundak == 1
        
        * Count applications by district
        contract district_mod `prepvar'
        
        * Compute total plots per district
        by district_mod (`prepvar'), sort: gen total = sum(_freq)
        by district_mod (`prepvar'), sort: replace total = total[_N]
        
        * Compute percentages
        gen percent = 100 * _freq / total
        replace percent = round(percent,0.01)
        drop _freq total
        
        * Reshape to wide format for this prep variable
        reshape wide percent, i(district_mod) j(`prepvar')
        
        * Drop unnecessary percent columns if exist
        capture drop percent9998
        capture drop percent7
        
        * Rename columns with prepvar suffix
        rename percent* percent*_`prepvar'
        foreach v of varlist percent*_`prepvar' {
    replace `v' = 0 if missing(`v')
}

        * Save temporary result
        tempfile tmp
        save `tmp'

        * Merge into cumulative Season_data
        capture confirm file `Season_data'
        if _rc != 0 {
            * First dataset
            use `tmp', clear
            save `Season_data', replace
        }
        else {
            use `Season_data', clear
            merge 1:1 district_mod using `tmp'
            drop _merge
            save `Season_data', replace
        }
    restore
}
<</dd_do>>

<h5 style='text-align: left;'>Mundakan</h5>

<div>
<table border="1" style="border-collapse: collapse; width: 50%; text-align: center;">
  <thead style="background-color: #f2f2f2;">
    <tr>
      <th>District</th>
      <th>Use for mulching (%)</th>
      <th> Mix with soil for manuring (%)</th>
      <th>Use/sell it for bioenergy/biogas/biochar production (%)</th>
      <th>Sell it for other purposes like fodder, etc(%)</th>
      <th>Use as dry fodder for own cattle (%)</th>
      <th>Burn it(%)</th>
    </tr>
  </thead>


<<dd_do:nocommands nooutput>>
use `Season_data', clear
levelsof district_mod, local(districts)
<</dd_do>>
<<dd_do:nocommands >>

foreach d of local districts {
    capture confirm variable percent1_mundank_posthavr2_1
    if !_rc {
        quietly su percent1_mundank_posthavr2_1 if district_mod == `d', meanonly
        local p1 = string(r(mean), "%9.2f")
    }
    else local p1 = "NA"

    capture confirm variable percent1_mundank_posthavr2_2
    if !_rc {
        quietly su percent1_mundank_posthavr2_2 if district_mod == `d', meanonly
        local p2 = string(r(mean), "%9.2f")
    }
    else local p2 = "NA"

    capture confirm variable percent1_mundank_posthavr2_3
    if !_rc {
        quietly su percent1_mundank_posthavr2_3 if district_mod == `d', meanonly
        local p3 = string(r(mean), "%9.2f")
    }
    else local p3 = "NA"

    capture confirm variable percent1_mundank_posthavr2_4
    if !_rc {
        quietly su percent1_mundank_posthavr2_4 if district_mod == `d', meanonly
        local p4 = string(r(mean), "%9.2f")
    }
    else local p4 = "NA"

    capture confirm variable percent1_mundank_posthavr2_5
    if !_rc {
        quietly su percent1_mundank_posthavr2_5 if district_mod == `d', meanonly
        local p5 = string(r(mean), "%9.2f")
    }
    else local p5 = "NA"

    capture confirm variable percent1_mundank_posthavr2_6
    if !_rc {
        quietly su percent1_mundank_posthavr2_6 if district_mod == `d', meanonly
        local p6 = string(r(mean), "%9.2f")
    }
    else local p6 = "NA"



    capture local name : label (district_mod) `d'
    if _rc != 0 local name = string(`d')

    di "<tr><td>`name'</td><td>`p1'</td><td>`p2'</td><td>`p3'</td><td>`p4'</td><td>`p5'</td><td>`p6'</td></tr>"
}

* Now compute totals for all districts (overall)
capture confirm variable percent1_mundank_posthavr2_1
if !_rc {
    quietly su percent1_mundank_posthavr2_1, meanonly
    local p1S = string(r(mean), "%9.2f")
}
else local p1S = "NA"

capture confirm variable percent1_mundank_posthavr2_2
if !_rc {
    quietly su percent1_mundank_posthavr2_3, meanonly
    local p2S = string(r(mean), "%9.2f")
}
else local p2S = "NA"

capture confirm variable percent1_mundank_posthavr2_3
if !_rc {
    quietly su percent1_mundank_posthavr2_3, meanonly
    local p3S = string(r(mean), "%9.2f")
}
else local p3S = "NA"

capture confirm variable percent1_mundank_posthavr2_4
if !_rc {
    quietly su percent1_mundank_posthavr2_4, meanonly
    local p4S = string(r(mean), "%9.2f")
}
else local p4S = "NA"

capture confirm variable percent1_mundank_posthavr2_5
if !_rc {
    quietly su percent1_mundank_posthavr2_5, meanonly
    local p5S = string(r(mean), "%9.2f")
}
else local p5S = "NA"

capture confirm variable percent1_mundank_posthavr2_6
if !_rc {
    quietly su percent1_mundank_posthavr2_6, meanonly
    local p6S = string(r(mean), "%9.2f")
}
else local p6S = "NA"



* Print the total row once
di "<tr><td><strong>Total</strong></td><td>`p1S'</td><td>`p2S'</td><td>`p3S'</td><td>`p4S'</td><td>`p5S'</td><td>`p6S'</td></tr>"
<</dd_do>>
</table>
</div>


<!-- Ways of straw management (Puncha) -->
<<dd_do:nocommands nooutput >>
use "LCAS.dta"
local preplist puncha_posthavr2_1 puncha_posthavr2_2 puncha_posthavr2_3 puncha_posthavr2_4 puncha_posthavr2_5 puncha_posthavr2_6 puncha_posthavr2_7

* Temporary file to store the combined result
tempfile Season_data

*---------------------------------------------------
* 2. Loop through each strawmgmt variable
*---------------------------------------------------
local n : word count `preplist'
forvalues i = 1/`n' {
    
    local prepvar : word `i' of `preplist'
    
   
    preserve
        * Keep only cultivated cases for this season
        keep if ricecult_puncha == 1
        
        * Count applications by district
        contract district_mod `prepvar'
        
        * Compute total plots per district
        by district_mod (`prepvar'), sort: gen total = sum(_freq)
        by district_mod (`prepvar'), sort: replace total = total[_N]
        
        * Compute percentages
        gen percent = 100 * _freq / total
        replace percent = round(percent,0.01)
        drop _freq total
        
        * Reshape to wide format for this prep variable
        reshape wide percent, i(district_mod) j(`prepvar')
        
        * Drop unnecessary percent columns if exist
        capture drop percent9998
        capture drop percent7
        
        * Rename columns with prepvar suffix
        rename percent* percent*_`prepvar'
        foreach v of varlist percent*_`prepvar' {
    replace `v' = 0 if missing(`v')
}

        * Save temporary result
        tempfile tmp
        save `tmp'

        * Merge into cumulative Season_data
        capture confirm file `Season_data'
        if _rc != 0 {
            * First dataset
            use `tmp', clear
            save `Season_data', replace
        }
        else {
            use `Season_data', clear
            merge 1:1 district_mod using `tmp'
            drop _merge
            save `Season_data', replace
        }
  restore
}
<</dd_do>>

<h5 style='text-align: left;'>Puncha</h5>

<div>
<table border="1" style="border-collapse: collapse; width: 50%; text-align: center;">
  <thead style="background-color: #f2f2f2;">
      <tr>
      <th>District</th>
      <th>Use for mulching (%)</th>
      <th> Mix with soil for manuring (%)</th>
      <th>Use/sell it for bioenergy/biogas/biochar production (%)</th>
      <th>Sell it for other purposes like fodder, etc(%)</th>
      <th>Use as dry fodder for own cattle (%)</th>
      <th>Burn it(%)</th>
    </tr>
  </thead>


<<dd_do:nocommands nooutput>>
use `Season_data', clear
levelsof district_mod, local(districts)
<</dd_do>>
<<dd_do:nocommands >>
* First print the district-wise rows

foreach d of local districts {
    capture confirm variable percent1_puncha_posthavr2_1
    if !_rc {
        quietly su percent1_puncha_posthavr2_1 if district_mod == `d', meanonly
        local p1 = string(r(mean), "%9.2f")
    }
    else local p1 = "NA"

    capture confirm variable percent1_puncha_posthavr2_2
    if !_rc {
        quietly su percent1_puncha_posthavr2_2 if district_mod == `d', meanonly
        local p2 = string(r(mean), "%9.2f")
    }
    else local p2 = "NA"

    capture confirm variable percent1_puncha_posthavr2_3
    if !_rc {
        quietly su percent1_puncha_posthavr2_3 if district_mod == `d', meanonly
        local p3 = string(r(mean), "%9.2f")
    }
    else local p3 = "NA"

    capture confirm variable percent1_puncha_posthavr2_4
    if !_rc {
        quietly su percent1_puncha_posthavr2_4 if district_mod == `d', meanonly
        local p4 = string(r(mean), "%9.2f")
    }
    else local p4 = "NA"

    capture confirm variable percent1_puncha_posthavr2_5
    if !_rc {
        quietly su percent1_puncha_posthavr2_5 if district_mod == `d', meanonly
        local p5 = string(r(mean), "%9.2f")
    }
    else local p5 = "NA"

    capture confirm variable percent1_puncha_posthavr2_6
    if !_rc {
        quietly su percent1_puncha_posthavr2_6 if district_mod == `d', meanonly
        local p6 = string(r(mean), "%9.2f")
    }
    else local p6 = "NA"



    capture local name : label (district_mod) `d'
    if _rc != 0 local name = string(`d')

    di "<tr><td>`name'</td><td>`p1'</td><td>`p2'</td><td>`p3'</td><td>`p4'</td><td>`p5'</td><td>`p6'</td></tr>"
}

* Now compute totals for all districts (overall)
capture confirm variable percent1_puncha_posthavr2_1
if !_rc {
    quietly su percent1_puncha_posthavr2_1, meanonly
    local p1S = string(r(mean), "%9.2f")
}
else local p1S = "NA"

capture confirm variable percent1_puncha_posthavr2_2
if !_rc {
    quietly su percent1_puncha_posthavr2_2, meanonly
    local p2S = string(r(mean), "%9.2f")
}
else local p2S = "NA"

capture confirm variable percent1_puncha_posthavr2_3
if !_rc {
    quietly su percent1_puncha_posthavr2_3, meanonly
    local p3S = string(r(mean), "%9.2f")
}
else local p3S = "NA"

capture confirm variable percent1_puncha_posthavr2_4
if !_rc {
    quietly su percent1_puncha_posthavr2_4, meanonly
    local p4S = string(r(mean), "%9.2f")
}
else local p4S = "NA"

capture confirm variable percent1_puncha_posthavr2_5
if !_rc {
    quietly su percent1_puncha_posthavr2_5, meanonly
    local p5S = string(r(mean), "%9.2f")
}
else local p5S = "NA"

capture confirm variable percent1_puncha_posthavr2_6
if !_rc {
    quietly su percent1_puncha_posthavr2_6, meanonly
    local p6S = string(r(mean), "%9.2f")
}
else local p6S = "NA"


* Print the total row once
di "<tr><td><strong>Total</strong></td><td>`p1S'</td><td>`p2S'</td><td>`p3S'</td><td>`p4S'</td><td>`p5S'</td><td>`p6S'</td></tr>"
<</dd_do>>
</table>
</div>

</div>

<!-- SUBSECTION  :Emissions -->
<div id="GHG" class="tab-content">
<h4 style="color:darkblue;margin-top:5px;"><strong> GHG Emissions</strong></h4>
</div>

<!-- SUBSECTION  :Attitudes -->
<div id="attitude" class="tab-content">
<h4 style="color:darkblue;margin-top:5px;"><strong> Farmer knowledge and willingness towards LEPs</strong></h4>

<<dd_do:nocommands nooutput >>
use "LCAS.dta", clear

* Temporary files
tempfile s1 s2 s3 combined htmlout

**************************************
* STATEMENT 1
**************************************
preserve
    contract district_mod flood_pollute
    bysort district_mod (flood_pollute): gen total = sum(_freq)
    bysort district_mod (flood_pollute): replace total = total[_N]
    bysort district_mod (flood_pollute): gen percent = 100 * _freq / total
    replace percent = round(percent, 0.01)
    drop _freq total
    reshape wide percent, i(district_mod) j(flood_pollute)
    keep district_mod percent1
    rename percent1 percent_s1
    save `s1'
restore
**************************************
* STATEMENT 2
**************************************
preserve
    contract district_mod intermitted_ghgred 
    bysort district_mod (intermitted_ghgred ): gen total = sum(_freq)
    bysort district_mod (intermitted_ghgred ): replace total = total[_N]
    bysort district_mod (intermitted_ghgred ): gen percent = 100 * _freq / total
    replace percent = round(percent, 0.01)
    drop _freq total
    reshape wide percent, i(district_mod) j(intermitted_ghgred)
    keep district_mod percent1
    rename percent1 percent_s2
    save `s2'
restore

**************************************
* STATEMENT 3
**************************************
preserve
    contract district_mod impwater_awd
    bysort district_mod (impwater_awd): gen total = sum(_freq)
    bysort district_mod (impwater_awd): replace total = total[_N]
    bysort district_mod (impwater_awd): gen percent = 100 * _freq / total
    replace percent = round(percent, 0.01)
    drop _freq total
    reshape wide percent, i(district_mod) j(impwater_awd)
    keep district_mod percent1
    rename percent1 percent_s3
    save `s3'
restore
**************************************
* MERGE ALL THREE STATEMENTS
**************************************
use `s1', clear
merge 1:1 district_mod using `s2', nogen
merge 1:1 district_mod using `s3', nogen
save `combined', replace

**************************************
* GENERATE HTML TABLE
**************************************
<</dd_do>>

<p>The proportion of respondents who marked "Yes" to these statements:</p>

<ol>
<li>Did you know that continuous flooding or water stagnation in rice field emits GHGs and pollute air?</li>
<li>Did you know that intermittent drying can help reduce GHG emissions from rice fields compared to continuous flooding?</li>
<li>Are you willing to practice improved water management such as AWD in the future?</li>
</ol>

<<dd_do:nocommands nooutput>>
file open outfile using "htmlout.html", write replace

file write outfile "<table border='1' style='border-collapse: collapse; width: 40%; font-size:100%; text-align: center;'>" _n
file write outfile "<tr style='background-color:#f2f2f2;'><th>District</th><th>Statement 1 (%)</th><th>Statement 2 (%)</th><th>Statement 3 (%)</th></tr>" _n

levelsof district_mod, local(districts)
foreach d of local districts {
    quietly su percent_s1 if district_mod == `d', meanonly
    local p1 = string(r(mean), "%9.2f")

    quietly su percent_s2 if district_mod == `d', meanonly
    local p2 = string(r(mean), "%9.2f")

    quietly su percent_s3 if district_mod == `d', meanonly
    local p3 = string(r(mean), "%9.2f")

    local name : label (district_mod) `d'
    file write outfile "<tr><td>`name'</td><td>`p1'</td><td>`p2'</td><td>`p3'</td></tr>" _n
}

file write outfile "</table>" _n
file close outfile
<</dd_do>>
<<dd_include: htmlout.html >>
</div>

<!-- SUBSECTION  :Image gallery -->
<div id="image" class="tab-content">
<div class="gallery-item">
  <img src="Images/Interview1.jpg" style="width:60px;">
  <br>
  <a href="Images/Interview1.jpg" download>Download</a>
</div>
</div>

<!-- SUBSECTION  :Knowledge products -->
<div id="download" class="tab-content">
<h3>Questionnaires</h3>
  <ul>
    <li>
      <a href="knowledge-products/Questionnaires/Baseline LCAS- Household Survey.pdf" download>
        Baseline LCAS- Household Survey
      </a>
    </li>
  </ul>
</div>

<!-- FOOTER -->
<div id="footer-bar" style="
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    background: #fff8e1;  /* light cream */
    border-top: 1px solid #ccc;
    padding: 8px 0;
    display: flex;
    justify-content: space-evenly;
    align-items: center;
    z-index: 1000;
    box-shadow: 0 -2px 6px rgba(0,0,0,0.15);  /* subtle shadow */
">
    <img src="Logo5.png" alt="Institution 1" style="height: 40px;">
    <img src="Logo2.jpeg" alt="Institution 2" style="height: 40px;">
    <img src="Logo3.jpeg" alt="Institution 3" style="height: 40px;">
    <img src="cwrdm.jpeg" alt="Institution 4" style="height: 40px;">
</div>


<script>

function openTab(evt, tabId) {
  // Hide all main contents
  document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.tab-link').forEach(btn => btn.classList.remove('active'));

  // Show clicked
  document.getElementById(tabId).classList.add('active');
  evt.currentTarget.classList.add('active');

  // Show subtabs only for Production
  const prodArea = document.getElementById('productionSubtabsArea');
  if (tabId === 'production') {
    prodArea.style.display = 'block';
    openSubTab(null, 'prod1');
  } else if (prodArea) {
    prodArea.style.display = 'none';
  }
}

function openSubTab(evt, subId) {
  document.querySelectorAll('#production .sub-tab-content').forEach(el => el.style.display = 'none');
  document.querySelectorAll('#production .sub-tab-link').forEach(btn => btn.classList.remove('active'));
  document.getElementById(subId).style.display = 'block';
  if (evt) evt.currentTarget.classList.add('active');
}

//Search 
let matches = [];
let currentIndex = -1;

const dashboard = document.getElementById('dashboardContent');

// Remove highlights
function removeHighlights(container) {
  container.querySelectorAll('mark.highlight')
    .forEach(m => m.replaceWith(m.textContent));

  matches = [];
  currentIndex = -1;
}

// Highlight text
function highlight(container, text) {
  if (!text) return;

  const regex = new RegExp(text, 'gi');
  container.innerHTML = container.innerHTML.replace(
    regex,
    match => `<mark class="highlight">${match}</mark>`
  );

  matches = Array.from(container.querySelectorAll('mark.highlight'));
}

// Activate tab if match is inside hidden tab
function activateTabContaining(element) {
  const tabContent = element.closest('.tab-content');
  if (!tabContent) return;

  // Remove active from all
  document.querySelectorAll('.tab-content')
    .forEach(t => t.classList.remove('active'));

  // Activate correct tab
  tabContent.classList.add('active');
}

// Scroll to match
function scrollToMatch(index) {
  if (matches.length === 0) return;

  matches.forEach(m => m.classList.remove('active-match'));

  currentIndex = index % matches.length;
  if (currentIndex < 0) currentIndex = matches.length - 1;

  const el = matches[currentIndex];

  activateTabContaining(el);

  el.classList.add('active-match');

  el.scrollIntoView({
    behavior: 'smooth',
    block: 'center'
  });
}

// Search button
document.getElementById('searchBtn').addEventListener('click', () => {
  const q = document.getElementById('searchInput').value.trim();

  removeHighlights(dashboard);

  if (q) {
    highlight(dashboard, q);
    if (matches.length > 0) {
      scrollToMatch(0);
    }
  }
});

// Enter key √É¬¢√¢‚Ç¨ √¢‚Ç¨‚Ñ¢ next match
document.getElementById('searchInput').addEventListener('keydown', (e) => {
  if (e.key === 'Enter') {
    e.preventDefault();
    if (matches.length > 0) {
      scrollToMatch(currentIndex + 1);
    }
  }
});

// Clear
document.getElementById('clearSearch').addEventListener('click', () => {
  removeHighlights(dashboard);
  document.getElementById('searchInput').value = '';
});

// Download
document.getElementById('downloadBtn').addEventListener('click', () => {
  // Add print-mode class to root container
  document.getElementById('pdfRoot').classList.add('print-mode');

  // Also open all production subtabs
  document.querySelectorAll('.sub-tab-content').forEach(st => st.classList.add('print-visible'));

  // Trigger print dialog
  window.print();

  // Remove print-mode after printing
  setTimeout(() => {
    document.getElementById('pdfRoot').classList.remove('print-mode');
    document.querySelectorAll('.sub-tab-content').forEach(st => st.classList.remove('print-visible'));
  }, 500);
});

</script>

</body>
</html>